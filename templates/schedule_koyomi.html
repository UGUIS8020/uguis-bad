{% extends "base.html" %}

{% block content %}

<style>
    .calendar-table {
        table-layout: fixed;
        width: 100%;
    }
    
    .calendar-table th {
        text-align: center;
        background-color: #8fbc13;
        color: white;
    }
    
    .calendar-day {
        height: 90px;
        vertical-align: top;
        padding: 5px;
        position: relative;
        background-color: #f8f9fa;
    }
    
    .day-number {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 5px;
    }
    
    .other-month {
        background-color: #f0f0f0;
        color: #aaa;
    }
    
    .today {
        background-color: #e6f7ff;
    }
    
    .schedule-marker {
        margin-top: 5px;
        text-align: center;
    }
    
    /* レスポンシブ対応 */
    @media (max-width: 768px) {
        .calendar-day {
            height: 60px;
            font-size: 0.8rem;
        }
        
        .day-number {
            font-size: 0.9rem;
        }
    }
    
    .accordion-button::after {
    display: none !important;  /* アコーディオンの矢印を非表示 */
}
.accordion-header{
    background-color: #ffffff;
    padding: 100;
    margin: 5;   
}

.accordion-button {  
    background-color: #ffffff;;  
    padding: 0;
    margin: 0;
    font-size: 1.2rem; /* フォントサイズを調整 */
}

.accordion-item {
    background-color: #ffffff;;
    padding: 5px;
    margin: 5px;
    border: 1px solid rgba(0,0,0,.125);
    border-radius: 0.25rem !important;
}

/* レスポンシブ調整 */
@media (max-width: 768px) {
    .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 0.5rem;
    }        
    
}

.participant-name {
    z-index: 1000;
    position: relative;
    pointer-events: auto;
}
</style>

<div class="container">       
    <section id="schedule" class="mb-5">                        
        <div class="schedule text-center">
            {% if not current_user.is_authenticated %}
            <div class="mt-3">
                <p>練習に参加するには仮登録しログインして、参加ボタンを押してください。
                <a href="{{ url_for('temp_register') }}" class="btn btn-warning">仮登録へ</a></p>
                <p>募集中であれば参加できます。初参加の方はmailかLINEでご連絡いただけると助かります</p>
            </div>
            {% endif %} 
           
            <div class="d-flex flex-column align-items-center gap-3 mb-4" >
                <a href="https://line.me/ti/p/gErDAMJEId" target="_blank" rel="noopener noreferrer" class="btn" style="background-color: #00B900; color: white; font-size: 1.5rem; width: 100%; max-width: 100%;"><b>LINEで連絡 ココをクリック</b></a>
            </div>

            <a class="question-link" href="https://bad-manager.shibuya8020.com/" target="_blank" rel="noopener noreferrer">
                <h2>ご質問はこちら。</h2>
            </a>

            <div class="schedule-title">
                <h2>練習予定</h2>           
            </div>            

                <!-- カレンダー表示 -->
            <div class="calendar-container my-4">
                <!-- カレンダーヘッダー（月表示と前後月ナビゲーション） -->
                <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
                    <a href="/schedule_koyomi/{{ prev_year }}/{{ prev_month }}" class="btn btn-outline-primary">&lt; 前月</a>
                    <h3 class="m-0">{{ year }}年{{ month_name }}</h3>
                    <a href="/schedule_koyomi/{{ next_year }}/{{ next_month }}" class="btn btn-outline-primary">次月 &gt;</a>
                </div>

                <!-- テーブル形式のカレンダー -->
                <div class="table-responsive">
                    <table class="table table-bordered calendar-table">
                        <thead>
                            <tr class="bg-success-subtle">
                                <th class="text-danger">日</th>
                                <th>月</th>
                                <th>火</th>
                                <th>水</th>
                                <th>木</th>
                                <th>金</th>
                                <th class="text-primary">土</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 動的カレンダー表示 -->
                            {% if calendar_data %}
                                {% for week in calendar_data %}
                                <tr>
                                    {% for day in week %}
                                    <td class="calendar-day {% if day.is_other_month %}other-month{% endif %} {% if day.is_today %}today{% endif %}">
                                        {% if day.day != 0 %}
                                        <div class="day-number {% if loop.index0 == 0 %}text-danger{% elif loop.index0 == 6 %}text-primary{% endif %}">
                                            {{ day.day }}
                                        </div>
                                        
                                        <!-- この日のスケジュール -->
                                        {% if day.has_schedule %}
                                        <div class="schedule-marker">
                                            {% if day.has_full_schedule %}
                                            <span class="badge bg-warning">満</span>
                                            {% else %}
                                            <span class="badge bg-success">募</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            {% else %}
                                <!-- カレンダーデータがない場合のフォールバック表示 -->
                                <tr>
                                    <td colspan="7" class="text-center py-3">
                                        カレンダーデータを読み込めませんでした。
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-primary" onclick="location.reload()">再読み込み</button>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- スケジュール一覧 -->
             <div class="schedule-title position-relative text-center">
                <h2 class="m-0">練習予定</h2>                
            </div>

            <!-- アコーディオン -->
    <div class="accordion" id="scheduleAccordion">
        {% for schedule in schedules %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ schedule.schedule_id }}">
                <div class="d-flex align-items-center justify-content-between">
                    <!-- 日付と会場情報 -->
                    <div class="d-flex align-items-center m-0 w-100">
                        

                        {% if current_user.is_authenticated and current_user.administrator %}
                        <button class="accordion-button collapsed p-2 w-100" 
                                type="button" 
                                style="width: auto; box-shadow: none;"
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapse{{ schedule.schedule_id }}"
                                aria-expanded="false"
                                aria-controls="collapse{{ schedule.schedule_id }}">
                            {% else %}
                            <!-- 一般ユーザー：見た目は同じ、クリック不可 -->
                            <div class="accordion-button collapsed p-2 w-100"
                                    style="width: auto; box-shadow: none; cursor: default;">
                            {% endif %}
                                
                            <div class="d-flex align-items-center flex-nowrap w-100">
                                <div class="d-flex align-items-center flex-grow-1">
                                    <span class="me-2">{{ schedule.date | format_date }}({{ schedule.day_of_week }})
                                    {{ schedule.start_time }} ~ {{ schedule.end_time }}<br>
                                
                                    {{ schedule.venue }}{{ schedule.court }}
                                    </span>
                                    
                                </div>
                                
                                <div>
                                    募集人数 {{ schedule.participants_count }}/{{ schedule.max_participants }}
                                    <!-- 募集状態 -->
                                    {% if schedule.participants_count >= schedule.max_participants %}
                                        <div class="badge bg-warning text-dark">満員御礼</div>
                                    {% else %}
                                        <div class="badge bg-success">募集中</div>
                                    {% endif %}
                                </div>
                        
                                
                                <!-- 時間と参加ボタン -->
                                
                                    <button
                                    class="btn btn-sm join-button m-1 text-nowrap                                          
                                    {% if not current_user.is_authenticated %}
                                        btn-secondary disabled
                                    {% elif schedule.participants_count >= schedule.max_participants and current_user.id not in schedule.participants %}
                                        btn-secondary disabled
                                    {% elif current_user.id in schedule.participants %}
                                        btn-danger
                                    {% else %}
                                        btn-primary
                                    {% endif %}"
                                    data-schedule-id="{{ schedule.schedule_id }}" 
                                    data-schedule-date="{{ schedule.date }}" 
                                    onclick="joinSchedule(this)"
                                    {% if not current_user.is_authenticated or 
                                        (schedule.participants_count >= schedule.max_participants and 
                                        current_user.id not in schedule.participants) %}disabled{% endif %}>
                                    
                                    {% if not current_user.is_authenticated %}
                                        参加
                                    {% elif schedule.participants_count >= schedule.max_participants and current_user.id not in schedule.participants %}
                                        満員御礼
                                    {% elif current_user.id in schedule.participants %}
                                        参加済
                                    {% else %}
                                        参加
                                    {% endif %}
                                </button>                         
                        </h2>
                        
                        {% if current_user.is_authenticated and current_user.administrator %}
                        <div id="collapse{{ schedule.schedule_id }}" 
                            class="accordion-collapse collapse" 
                            aria-labelledby="heading{{ schedule.schedule_id }}"
                            data-bs-parent="#scheduleAccordion">
                        <div class="accordion-body">
                            <!-- 参加者一覧 -->
                            <div class="text-start">
                                <h5 class="mb-3">
                                    <i class="bi bi-people-fill text-primary"></i>
                                    <a href="{{ url_for('day_of_participants', date=schedule.date) }}" class="text-decoration-none text-dark">
                                        参加者一覧
                                    </a>
                                </h5>
                            {% if schedule.participants_info %}                                             


                                <div class="row">
                                {% for participant in schedule.participants_info %}
                                    <div class="col-md-3 col-sm-4 mb-1">
                                    <div class="card">
                                        <div class="card-body py-2">
                                            
                                            <span class="participant-name">
                                                {{ participant.display_name }}

                                        </div>
                                    </div>
                                    </div>
                                {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">まだ参加者がいません</p>
                            {% endif %}
                            </div>
                        </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    </div>

    <script>
    async function joinSchedule(button) {
        const scheduleId = button.getAttribute('data-schedule-id');
        const scheduleDate = button.getAttribute('data-schedule-date');

        if (!scheduleId || !scheduleDate) {
            alert('スケジュール情報が不足しています。');
            return;
        }

        try {
            const response = await fetch(`/schedule/${scheduleId}/join`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ date: scheduleDate })
            });

            if (!response.ok) {
                const errorData = await response.json();
                alert(errorData.message || 'エラーが発生しました');
                return;
            }

            const data = await response.json();

            if (data.message) {
                alert(data.message);
            }

            // ページをリロードして変更を反映
            location.reload();

        } catch (error) {
            console.error('Fetch error:', error);
            alert('通信エラーが発生しました');
        }
    }
</script>

{% endblock %}






