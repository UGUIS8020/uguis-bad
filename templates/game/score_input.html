
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>スコア入力</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .submitted-btn {
            background-color: #6c757d; /* 灰色 */
            color: white;
            border: none;
        }
    
        .btn-orange {
            background-color: #fd7e14;  /* オレンジ */
            color: white;
            border: none;
        }
    
        /* デバッグ用スタイル */
        .debug-info {
            background-color: #f8d7da;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }

        /* スコア入力フィールドを大きくするスタイル */
        .score-input {
            font-size: 3rem !important;
            height: 5rem !important;
            text-align: center !important;
            font-weight: bold !important;
            border: 3px solid #28a745 !important;
            border-radius: 15px !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
        }

        .score-input:focus {
            border-color: #fd7e14 !important;
            box-shadow: 0 0 20px rgba(253, 126, 20, 0.5) !important;
        }

        /* チーム名表示を大きく */
        .team-name {
            font-size: 2.5rem !important;
            font-weight: bold !important;
            min-width: 400px;
            text-align: center;
        }

        /* バッジを大きく */
        .team-badge {
            font-size: 2.5rem !important;
            padding: 0.8rem 1.2rem !important;
            border-radius: 20px !important;
        }

        /* VS表示 */
        .vs-display {
            font-size: 4rem !important;
            font-weight: bold !important;
            color: #28a745;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* カードを大きく */
        .court-card {
            min-height: 600px;
        }

        /* スコア入力エリア全体のレイアウト改善 */
        .score-row {
            margin: 2rem 0 !important;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        /* ボタンも大きく */
        .submit-btn {
            font-size: 2rem !important;
            padding: 1rem 3rem !important;
            border-radius: 15px !important;
            font-weight: bold !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .team-name {
                font-size: 1.8rem !important;
                min-width: 250px;
            }
            
            .score-input {
                font-size: 2.5rem !important;
                height: 4rem !important;
            }
            
            .vs-display {
                font-size: 3rem !important;
            }
            
            .team-badge {
                font-size: 2rem !important;
                padding: 0.6rem 1rem !important;
            }
        }
    </style>
</head>
<body class="bg-light">    

<div class="container-fluid mt-4">
    <h2 class="mb-4">スコア入力画面</h2>    
    
    <!-- デバッグ情報表示エリア -->
    <div id="debug-info" class="debug-info">
        <p><strong>デバッグ情報:</strong></p>
        <pre id="debug-data"></pre>
        <button onclick="toggleDebug()" class="btn btn-sm btn-secondary">閉じる</button>
    </div>

    <!-- データが空の場合のメッセージ -->
    <div id="no-data-message" class="alert alert-warning" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i> 表示するコートデータがありません。管理者に連絡してください。
    </div>

    <div class="container mt-4">
        <div class="d-flex justify-content-center align-items-center gap-3 mb-3 flex-wrap">
            <h3 class="text-success fw-bold mb-0">
                🎾 本日の試合（{{ court_data|length }}面）
            </h3>
            <form method="post" action="{{ url_for('game.set_score_format') }}" class="mb-0">
                <div class="input-group input-group-lg">
                    <label class="input-group-text" for="score_format">試合点数</label>
                    <select class="form-select form-select-lg" name="score_format" id="score_format" onchange="this.form.submit()">
                        <option value="15" {% if session.get('score_format') == '15' %}selected{% endif %}>15点</option>
                        <option value="21" {% if session.get('score_format') == '21' %}selected{% endif %}>21点</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- コートデータのループ -->
    <div class="row row-cols-1 g-4">
        {% if match_courts and match_courts|length > 0 %}
            {% for court_num, court in match_courts.items() %}
            <div class="col">
                <div class="card h-100 shadow-lg court-card">
                    <div class="card-header bg-success text-white text-center">
                        <h2 class="mb-0">🎾 コート{{ court_num }}</h2>
                    </div>
                    <div class="card-body p-4">
                        <form class="score-form" 
                            data-court-number="{{ court_num }}"
                            id="score-form-{{ court_num }}"
                            action="{{ url_for('game.submit_score', match_id=match_id, court_number=court_num) }}">                            
                            
                            <!-- チームA -->
                            <div class="score-row">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-danger me-3 team-badge">A</span>
                                        <span class="team-name">
                                            {% for player in court.team_a %}
                                                {{ player.display_name }}{% if not loop.last %} & {% endif %}
                                            {% endfor %}
                                        </span>
                                    </div>
                                    <div style="width: 200px;">                                
                                        <input type="number" name="team1_score" class="form-control score-input"
                                            required min="0" placeholder="0"
                                            inputmode="numeric" pattern="\d*">
                                    </div>
                                </div>
                            </div>

                            <!-- VS表示 -->
                            <div class="text-center my-4">
                                <span class="vs-display">VS</span>
                            </div>

                            <!-- チームB -->
                            <div class="score-row">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-primary me-3 team-badge">B</span>
                                        <span class="team-name">
                                            {% for player in court.team_b %}
                                                {{ player.display_name }}{% if not loop.last %} & {% endif %}
                                            {% endfor %}
                                        </span>
                                    </div>
                                    <div style="width: 200px;">                                
                                        <input type="number" name="team2_score" class="form-control score-input"
                                            required min="0" placeholder="0"
                                            inputmode="numeric" pattern="\d*">
                                    </div>                         
                                </div>
                            </div>
                                
                            <div class="text-center mt-5">
                                <button type="submit" class="btn btn-orange submit-btn">
                                    <i class="fas fa-trophy me-2"></i>スコア送信
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> コートデータが設定されていません。管理者に連絡してください。
                </div>
            </div>
        {% endif %}
    </div>

    <!-- 試合終了ボタン -->
    <form method="POST" action="{{ url_for('game.finish_current_match') }}">
        <div class="text-center mt-5 mb-5">
            <button id="endMatchButton" type="submit" class="btn btn-danger btn-xl px-5 py-3 fs-2" disabled>
                <i class="fas fa-flag-checkered me-2"></i>試合終了
            </button>
        </div>
    </form>

    <!-- デバッグボタン -->
    <div class="text-center mb-5">
        <button id="debugButton" class="btn btn-secondary">デバッグ情報表示</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const forms = document.querySelectorAll(".score-form");
        const formStatus = {};
        let submittedCount = 0;
        const totalForms = forms.length;
        
        // データがない場合のメッセージ表示
        if (totalForms === 0) {
            document.getElementById("no-data-message").style.display = "block";
        }
    
        // 試合終了ボタンを初期状態で無効に
        const endButton = document.getElementById("endMatchButton");
        if (endButton) endButton.disabled = true;
    
        // 各スコアフォームの送信処理
        forms.forEach((form, index) => {
            const formId = form.getAttribute("id");
            formStatus[formId] = { submitted: false };
    
            form.addEventListener("submit", function (e) {
                e.preventDefault();
    
                const formData = new FormData(form);
                const actionUrl = form.getAttribute("action");
                
                // 同点チェック
                const team1Score = parseInt(formData.get("team1_score"));
                const team2Score = parseInt(formData.get("team2_score"));
                
                if (team1Score === team2Score) {
                    alert("スコアが同点です。勝者を決めてください。");
                    return;
                }
    
                fetch(actionUrl, {
                    method: "POST",
                    body: formData,
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || "送信エラー");
                        });
                    }
                    return response;
                })
                .then(() => {
                    const submitBtn = form.querySelector("button[type='submit']");
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>送信済み';
                        submitBtn.classList.remove("btn-orange");
                        submitBtn.classList.add("submitted-btn");
                    }
    
                    formStatus[formId].submitted = true;
                    submittedCount++;
    
                    if (submittedCount === totalForms && endButton) {
                        console.log("✅ 全スコア送信完了 → 試合終了ボタン有効化");
                        endButton.disabled = false;
                    }
                })
                .catch(error => {
                    alert(error.message || "スコア送信に失敗しました");
                    console.error(error);
                });
            });
        });
    
        // ✅ 試合終了ボタンのクリック処理を追加
        if (endButton) {
            endButton.addEventListener("click", function (e) {
                e.preventDefault();
                
                // ボタンを即座に無効化（重複クリック防止）
                endButton.disabled = true;
                endButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>処理中...';

                fetch("/game/finish_current_match", {
                    method: "POST",
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'  // Ajax判定用ヘッダー
                    }
                })
                .then(res => res.json())  // JSONレスポンスを期待
                .then(data => {
                    if (data.success) {
                        window.location.href = "/game/court";
                    } else {
                        throw new Error(data.error || "処理に失敗しました");
                    }
                })
                .catch(error => {
                    // エラー時はボタンを再度有効化
                    endButton.disabled = false;
                    endButton.innerHTML = '<i class="fas fa-flag-checkered me-2"></i>試合終了';
                    alert(error.message || "通信エラーが発生しました");
                    console.error(error);
                });
            });
        }

        // デバッグボタンの設定
        const debugButton = document.getElementById("debugButton");
        if (debugButton) {
            debugButton.addEventListener("click", function() {
                // サーバーからデータを取得
                fetch("/game/debug_data")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("debug-data").textContent = JSON.stringify(data, null, 2);
                    document.getElementById("debug-info").style.display = "block";
                })
                .catch(error => {
                    console.error("デバッグデータの取得に失敗:", error);
                    document.getElementById("debug-data").textContent = "データ取得エラー: " + error.message;
                    document.getElementById("debug-info").style.display = "block";
                });
            });
        }

        // スコア入力フィールドにフォーカス時のアニメーション効果
        document.querySelectorAll('.score-input').forEach(input => {
            input.addEventListener('focus', function() {
                this.style.transform = 'scale(1.05)';
                this.style.transition = 'transform 0.2s ease';
            });
            
            input.addEventListener('blur', function() {
                this.style.transform = 'scale(1)';
            });
        });
    });

    // デバッグ情報の表示/非表示を切り替える関数
    function toggleDebug() {
        const debugInfo = document.getElementById("debug-info");
        debugInfo.style.display = debugInfo.style.display === "none" ? "block" : "none";
    }
</script>

</body>
</html>