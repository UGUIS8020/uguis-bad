
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¹ã‚³ã‚¢å…¥åŠ›</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .submitted-btn {
            background-color: #6c757d; /* ç°è‰² */
            color: white;
            border: none;
        }
    
        .btn-orange {
            background-color: #fd7e14;  /* ã‚ªãƒ¬ãƒ³ã‚¸ */
            color: white;
            border: none;
        }
    
        /* ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .debug-info {
            background-color: #f8d7da;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }

        /* ã‚¹ã‚³ã‚¢å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¤§ããã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .score-input {
            font-size: 3rem !important;
            height: 5rem !important;
            text-align: center !important;
            font-weight: bold !important;
            border: 3px solid #28a745 !important;
            border-radius: 15px !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
        }

        .score-input:focus {
            border-color: #fd7e14 !important;
            box-shadow: 0 0 20px rgba(253, 126, 20, 0.5) !important;
        }

        /* ãƒãƒ¼ãƒ åè¡¨ç¤ºã‚’å¤§ãã */
        .team-name {
            font-size: 2.5rem !important;
            font-weight: bold !important;
            min-width: 400px;
            text-align: center;
        }

        /* ãƒãƒƒã‚¸ã‚’å¤§ãã */
        .team-badge {
            font-size: 2.5rem !important;
            padding: 0.8rem 1.2rem !important;
            border-radius: 20px !important;
        }

        /* VSè¡¨ç¤º */
        .vs-display {
            font-size: 4rem !important;
            font-weight: bold !important;
            color: #28a745;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚’å¤§ãã */
        .court-card {
            min-height: 600px;
        }

        /* ã‚¹ã‚³ã‚¢å…¥åŠ›ã‚¨ãƒªã‚¢å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„ */
        .score-row {
            margin: 2rem 0 !important;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        /* ãƒœã‚¿ãƒ³ã‚‚å¤§ãã */
        .submit-btn {
            font-size: 2rem !important;
            padding: 1rem 3rem !important;
            border-radius: 15px !important;
            font-weight: bold !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .team-name {
                font-size: 1.8rem !important;
                min-width: 250px;
            }
            
            .score-input {
                font-size: 2.5rem !important;
                height: 4rem !important;
            }
            
            .vs-display {
                font-size: 3rem !important;
            }
            
            .team-badge {
                font-size: 2rem !important;
                padding: 0.6rem 1rem !important;
            }
        }        
        .score-stepper{
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .score-step-btn{
          width: 5rem;
          height: 4.5rem;
          font-size: 2.5rem;
          font-weight: bold;
          padding: 0;
          line-height: 0;
        }
      
    </style>

<meta name="csrf-token" content="{{ csrf_token() }}">

</head>
<body class="bg-light">    

<div class="container-fluid mt-4">
    <h2 class="mb-4">ã‚¹ã‚³ã‚¢å…¥åŠ›ç”»é¢</h2>    
    
    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="debug-info" class="debug-info">
        <p><strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong></p>
        <pre id="debug-data"></pre>
        <button onclick="toggleDebug()" class="btn btn-sm btn-secondary">é–‰ã˜ã‚‹</button>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="no-data-message" class="alert alert-warning" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i> è¡¨ç¤ºã™ã‚‹ã‚³ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="container mt-4">
        <div class="d-flex justify-content-center align-items-center gap-3 mb-3 flex-wrap">
            <h3 class="text-success fw-bold mb-0">
                æœ¬æ—¥ã®è©¦åˆï¼ˆ{{ court_data|length }}é¢ï¼‰
            </h3>
            <form method="post" action="{{ url_for('game.set_score_format') }}" class="mb-0">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="input-group input-group-lg">
                    <label class="input-group-text" for="score_format">è©¦åˆç‚¹æ•°</label>
                    <select class="form-select form-select-lg" name="score_format" id="score_format" onchange="this.form.submit()">
                        <option value="15" {% if session.get('score_format') == '15' %}selected{% endif %}>15ç‚¹</option>
                        <option value="21" {% if session.get('score_format') == '21' %}selected{% endif %}>21ç‚¹</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- ã‚³ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ«ãƒ¼ãƒ— -->
    <div class="row row-cols-1 g-4">
    {% if match_courts and match_courts|length > 0 %}
        {% for court_num, court in match_courts.items() %}
        <div class="col">
            <div class="card h-100 shadow-lg court-card">
                <div class="card-header bg-success text-white text-center">
                    <h2 class="mb-0">ğŸ¾ ã‚³ãƒ¼ãƒˆ{{ court_num }}</h2>
                </div>
                <div class="card-body p-4">
                    <form class="score-form"
                          method="POST"
                          data-court-number="{{ court_num }}"
                          id="score-form-{{ court_num }}"
                          action="{{ url_for('game.submit_score', match_id=match_id, court_number=court_num) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="score-row mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center flex-grow-1">
                                    <span class="badge bg-danger me-3 team-badge">A</span>
                                    <span class="team-name">
                                        {% for player in court.team_a %}
                                            {{ player.display_name }}{% if not loop.last %} & {% endif %}
                                        {% endfor %}
                                    </span>
                                </div>
                                <div class="score-stepper" style="width: 220px;">
                                  <button type="button"
                                          class="btn btn-outline-secondary score-step-btn"
                                          onclick="stepScore(this, -1)">ï¼</button>

                                  <input type="text"
                                        name="team1_score"
                                        class="form-control score-input text-center"
                                        value="21"
                                        required
                                        inputmode="numeric"
                                        pattern="[0-9]*"
                                        style="font-size: 2.5rem; height: 4.5rem; font-weight: bold;"
                                        placeholder="0"
                                        data-min="0"
                                        data-max="99"
                                        data-step="1">

                                  <button type="button"
                                          class="btn btn-outline-secondary score-step-btn"
                                          onclick="stepScore(this, 1)">ï¼‹</button>
                                </div>
                            </div>
                        </div>
                        

                        <div class="score-row mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center flex-grow-1">
                                    <span class="badge bg-primary me-3 team-badge">B</span>
                                    <span class="team-name">
                                        {% for player in court.team_b %}
                                            {{ player.display_name }}{% if not loop.last %} & {% endif %}
                                        {% endfor %}
                                    </span>
                                </div> 
                                <div class="score-stepper" style="width: 220px;">
                                  <button type="button"
                                          class="btn btn-outline-secondary score-step-btn"
                                          onclick="stepScore(this, -1)">ï¼</button>

                                  <input type="text"
                                        name="team2_score"
                                        class="form-control score-input text-center"
                                        value="21"
                                        required
                                        inputmode="numeric"
                                        pattern="[0-9]*"
                                        style="font-size: 2.5rem; height: 4.5rem; font-weight: bold;"
                                        placeholder="0"
                                        data-min="0"
                                        data-max="99"
                                        data-step="1">

                                  <button type="button"
                                          class="btn btn-outline-secondary score-step-btn"
                                          onclick="stepScore(this, 1)">ï¼‹</button>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-5">
                            <button type="submit" class="btn btn-orange submit-btn w-100 py-3" style="font-size: 1.25rem; font-weight: bold; border-radius: 10px;">
                                <i class="fas fa-trophy me-2"></i>ã‚¹ã‚³ã‚¢é€ä¿¡
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> ã‚³ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚
            </div>
        </div>
    {% endif %}
</div>

    <!-- è©¦åˆçµ‚äº†ãƒœã‚¿ãƒ³ -->
    <form method="POST" action="{{ url_for('game.finish_current_match') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="text-center mt-5 mb-5">
            <button id="endMatchButton" type="submit" class="btn btn-danger btn-xl px-5 py-3 fs-2" disabled>
                <i class="fas fa-flag-checkered me-2"></i>è©¦åˆçµ‚äº†
            </button>
        </div>
    </form>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ -->
    <div class="text-center mb-5">
        <button id="debugButton" class="btn btn-secondary">ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const forms = document.querySelectorAll(".score-form");
  const totalForms = forms.length;

  // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  if (totalForms === 0) {
    const msg = document.getElementById("no-data-message");
    if (msg) msg.style.display = "block";
  }

  // CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆmetaå„ªå…ˆã€ç„¡ã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ hiddenã‹ã‚‰æ‹¾ã†ï¼‰
  function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.getAttribute("content")) return meta.getAttribute("content");

    // ä¿é™ºï¼šæœ€åˆã®ãƒ•ã‚©ãƒ¼ãƒ å†… hidden ã‚’æ¢ã™
    const hidden = document.querySelector('input[name="csrf_token"]');
    if (hidden && hidden.value) return hidden.value;

    return "";
  }
  const CSRF_TOKEN = getCsrfToken();

  // è©¦åˆçµ‚äº†ãƒœã‚¿ãƒ³
  const endButton = document.getElementById("endMatchButton");
  if (endButton) endButton.disabled = true;

  // é€ä¿¡æ¸ˆã¿ç®¡ç†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ IDå˜ä½ï¼‰
  const formStatus = {};
  let submittedCount = 0;

  // è‡ªå‹•finishï¼ˆäºŒé‡å®Ÿè¡Œé˜²æ­¢ï¼‰
  let finishTriggered = false;

  function setEndButtonProcessing() {
    if (!endButton) return;
    endButton.disabled = true;
    endButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å‡¦ç†ä¸­...';
  }

  function restoreEndButton() {
    if (!endButton) return;
    endButton.disabled = false;
    endButton.innerHTML = '<i class="fas fa-flag-checkered me-2"></i>è©¦åˆçµ‚äº†';
  }

  function disableEndButton() {
    if (!endButton) return;
    endButton.disabled = true;
    endButton.innerHTML = '<i class="fas fa-flag-checkered me-2"></i>è©¦åˆçµ‚äº†';
  }

  // â˜… CSRFä»˜ãã§POSTã™ã‚‹å…±é€šé–¢æ•°ï¼ˆFormData/JSONã©ã¡ã‚‰ã‚‚å¯¾å¿œï¼‰
  function postWithCsrf(url, { formData = null, jsonBody = null, extraHeaders = {} } = {}) {
    const headers = Object.assign({}, extraHeaders);

    // Flask-WTF(CSRFProtect)ã¯ã“ã®ãƒ˜ãƒƒãƒ€åã‚’è¦‹ã¾ã™
    if (CSRF_TOKEN) headers["X-CSRFToken"] = CSRF_TOKEN;
    headers["X-Requested-With"] = headers["X-Requested-With"] || "XMLHttpRequest";

    const options = { method: "POST", headers };

    if (formData) {
      // FormData ã« csrf_token ãŒç„¡ã‘ã‚Œã°ä»˜ä¸ï¼ˆã‚µãƒ¼ãƒå´ãŒãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ¤œè¨¼ã™ã‚‹å ´åˆã«å‚™ãˆã‚‹ï¼‰
      if (CSRF_TOKEN && !formData.has("csrf_token")) {
        formData.append("csrf_token", CSRF_TOKEN);
      }
      options.body = formData;
      // Content-Type ã¯ fetch ãŒè‡ªå‹•ã§ multipart/form-data; boundary ã‚’ä»˜ã‘ã‚‹ã®ã§è¨­å®šã—ãªã„
    } else if (jsonBody) {
      headers["Content-Type"] = "application/json";
      options.body = JSON.stringify(jsonBody);
    }

    return fetch(url, options);
  }

  function finishMatchAjax({ auto = false } = {}) {
    if (auto) {
      if (finishTriggered) return;
      finishTriggered = true;
    }

    setEndButtonProcessing();

    postWithCsrf("/game/finish_current_match")
      .then(async (res) => {
        const text = await res.text();
        try {
          const data = JSON.parse(text);
          if (!res.ok) throw new Error(data.error || "è©¦åˆçµ‚äº†ã«å¤±æ•—ã—ã¾ã—ãŸ");
          return data;
        } catch {
          if (!res.ok) throw new Error(text || "è©¦åˆçµ‚äº†ã«å¤±æ•—ã—ã¾ã—ãŸ");
          return { success: true };
        }
      })
      .then((data) => {
        if (data && data.success) {
          window.location.href = "/game/court";
          return;
        }
        if (auto) finishTriggered = false;
        restoreEndButton();
        alert((data && data.error) || "è©¦åˆçµ‚äº†ã«å¤±æ•—ã—ã¾ã—ãŸ");
      })
      .catch((err) => {
        if (auto) finishTriggered = false;
        restoreEndButton();
        alert(err.message || "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        console.error(err);
      });
  }

  function onAllSubmitted() {
    console.log("å…¨ã‚¹ã‚³ã‚¢é€ä¿¡å®Œäº† â†’ è‡ªå‹•ã§è©¦åˆçµ‚äº†");
    finishMatchAjax({ auto: true });
  }

  // å„ã‚¹ã‚³ã‚¢ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
  forms.forEach((form) => {
    const formId = form.getAttribute("id") || `score-form-${Math.random().toString(36).slice(2)}`;
    formStatus[formId] = { submitted: false };

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      if (formStatus[formId].submitted) return;

      const formData = new FormData(form);
      const actionUrl = form.getAttribute("action");

      const team1Score = Number(formData.get("team1_score"));
      const team2Score = Number(formData.get("team2_score"));

      if (Number.isNaN(team1Score) || Number.isNaN(team2Score)) {
        alert("ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (team1Score === team2Score) {
        alert("ã‚¹ã‚³ã‚¢ãŒåŒç‚¹ã§ã™ã€‚å‹è€…ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚");
        return;
      }

      const submitBtn = form.querySelector("button[type='submit']");
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>é€ä¿¡ä¸­...';
      }

      postWithCsrf(actionUrl, { formData })
        .then(async (response) => {
          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || "é€ä¿¡ã‚¨ãƒ©ãƒ¼");
          }
          return response;
        })
        .then(() => {
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>é€ä¿¡æ¸ˆã¿';
            submitBtn.classList.remove("btn-orange");
            submitBtn.classList.add("submitted-btn");
          }

          form.querySelectorAll("input").forEach((inp) => (inp.disabled = true));
          form.style.pointerEvents = "none";
          form.style.opacity = "0.9";

          formStatus[formId].submitted = true;
          submittedCount++;

          if (submittedCount === totalForms) {
            onAllSubmitted();
          } else {
            disableEndButton();
          }
        })
        .catch((error) => {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-trophy me-2"></i>ã‚¹ã‚³ã‚¢é€ä¿¡';
          }
          alert(error.message || "ã‚¹ã‚³ã‚¢é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
          console.error(error);
        });
    });
  });

  // æ‰‹å‹•finishï¼ˆè‡ªå‹•å¤±æ•—ã®ä¿é™ºï¼‰
  if (endButton) {
    endButton.addEventListener("click", function (e) {
      e.preventDefault();

      if (submittedCount !== totalForms) {
        alert("æœªé€ä¿¡ã®ã‚³ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ã™ã¹ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (finishTriggered) return;

      finishMatchAjax({ auto: false });
    });
  }

  // ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ï¼ˆGETãªã®ã§CSRFä¸è¦ï¼‰
  const debugButton = document.getElementById("debugButton");
  if (debugButton) {
    debugButton.addEventListener("click", function () {
      fetch("/game/debug_data")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("debug-data").textContent = JSON.stringify(data, null, 2);
          document.getElementById("debug-info").style.display = "block";
        })
        .catch((error) => {
          console.error("ãƒ‡ãƒãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:", error);
          document.getElementById("debug-data").textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: " + error.message;
          document.getElementById("debug-info").style.display = "block";
        });
    });
  }

  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  document.querySelectorAll(".score-input").forEach((input) => {
    input.addEventListener("focus", function () {
      this.style.transform = "scale(1.05)";
      this.style.transition = "transform 0.2s ease";
    });
    input.addEventListener("blur", function () {
      this.style.transform = "scale(1)";
    });
  });
});

// ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡æ›¿
function toggleDebug() {
  const debugInfo = document.getElementById("debug-info");
  debugInfo.style.display = debugInfo.style.display === "none" ? "block" : "none";
}
</script>

<script>
  function stepScore(btn, deltaSign) {
    // btn ã®è¦ª(.score-stepper)ã‹ã‚‰ input ã‚’æ¢ã™
    const wrapper = btn.closest('.score-stepper');
    const input = wrapper.querySelector('input.score-input');

    const step = parseInt(input.dataset.step || '1', 10);
    const min  = parseInt(input.dataset.min  || '0', 10);
    const max  = parseInt(input.dataset.max  || '999', 10);

    // ç¾åœ¨å€¤ï¼ˆç©ºã‚„ä¸æ­£ãªã‚‰ 0ï¼‰
    let v = parseInt((input.value || '0').replace(/[^\d]/g, ''), 10);
    if (Number.isNaN(v)) v = 0;

    // å¢—æ¸›
    v = v + (deltaSign * step);

    // clamp
    if (v < min) v = min;
    if (v > max) v = max;

    input.value = String(v);

    // ã‚‚ã—ã€Œå…¥åŠ›å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã€ã§ä»–å‡¦ç†ã—ã¦ã‚‹ãªã‚‰ç™ºç«
    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
  }

  // æ‰‹å…¥åŠ›ã§ã‚‚æ•°å­—ä»¥å¤–ã‚’é™¤å»ï¼ˆä»»æ„ï¼‰
  document.addEventListener('input', (e) => {
    if (!e.target.classList.contains('score-input')) return;
    e.target.value = e.target.value.replace(/[^\d]/g, '');
  });
</script>

</body>
</html>