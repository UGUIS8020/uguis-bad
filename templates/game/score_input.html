
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¹ã‚³ã‚¢å…¥åŠ›</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .submitted-btn {
            background-color: #6c757d; /* ç°è‰² */
            color: white;
            border: none;
        }
    
        .btn-orange {
            background-color: #fd7e14;  /* ã‚ªãƒ¬ãƒ³ã‚¸ */
            color: white;
            border: none;
        }
    
        /* ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .debug-info {
            background-color: #f8d7da;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }

        /* ã‚¹ã‚³ã‚¢å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¤§ããã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .score-input {
            font-size: 3rem !important;
            height: 5rem !important;
            text-align: center !important;
            font-weight: bold !important;
            border: 3px solid #28a745 !important;
            border-radius: 15px !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
        }

        .score-input:focus {
            border-color: #fd7e14 !important;
            box-shadow: 0 0 20px rgba(253, 126, 20, 0.5) !important;
        }

        /* ãƒãƒ¼ãƒ åè¡¨ç¤ºã‚’å¤§ãã */
        .team-name {
            font-size: 2.5rem !important;
            font-weight: bold !important;
            min-width: 400px;
            text-align: center;
        }

        /* ãƒãƒƒã‚¸ã‚’å¤§ãã */
        .team-badge {
            font-size: 2.5rem !important;
            padding: 0.8rem 1.2rem !important;
            border-radius: 20px !important;
        }

        /* VSè¡¨ç¤º */
        .vs-display {
            font-size: 4rem !important;
            font-weight: bold !important;
            color: #28a745;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚’å¤§ãã */
        .court-card {
            min-height: 600px;
        }

        /* ã‚¹ã‚³ã‚¢å…¥åŠ›ã‚¨ãƒªã‚¢å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„ */
        .score-row {
            margin: 2rem 0 !important;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        /* ãƒœã‚¿ãƒ³ã‚‚å¤§ãã */
        .submit-btn {
            font-size: 2rem !important;
            padding: 1rem 3rem !important;
            border-radius: 15px !important;
            font-weight: bold !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .team-name {
                font-size: 1.8rem !important;
                min-width: 250px;
            }
            
            .score-input {
                font-size: 2.5rem !important;
                height: 4rem !important;
            }
            
            .vs-display {
                font-size: 3rem !important;
            }
            
            .team-badge {
                font-size: 2rem !important;
                padding: 0.6rem 1rem !important;
            }
        }
    </style>
</head>
<body class="bg-light">    

<div class="container-fluid mt-4">
    <h2 class="mb-4">ã‚¹ã‚³ã‚¢å…¥åŠ›ç”»é¢</h2>    
    
    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="debug-info" class="debug-info">
        <p><strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong></p>
        <pre id="debug-data"></pre>
        <button onclick="toggleDebug()" class="btn btn-sm btn-secondary">é–‰ã˜ã‚‹</button>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="no-data-message" class="alert alert-warning" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i> è¡¨ç¤ºã™ã‚‹ã‚³ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="container mt-4">
        <div class="d-flex justify-content-center align-items-center gap-3 mb-3 flex-wrap">
            <h3 class="text-success fw-bold mb-0">
                æœ¬æ—¥ã®è©¦åˆï¼ˆ{{ court_data|length }}é¢ï¼‰
            </h3>
            <form method="post" action="{{ url_for('game.set_score_format') }}" class="mb-0">
                <div class="input-group input-group-lg">
                    <label class="input-group-text" for="score_format">è©¦åˆç‚¹æ•°</label>
                    <select class="form-select form-select-lg" name="score_format" id="score_format" onchange="this.form.submit()">
                        <option value="15" {% if session.get('score_format') == '15' %}selected{% endif %}>15ç‚¹</option>
                        <option value="21" {% if session.get('score_format') == '21' %}selected{% endif %}>21ç‚¹</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- ã‚³ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ«ãƒ¼ãƒ— -->
    <div class="row row-cols-1 g-4">
        {% if match_courts and match_courts|length > 0 %}
            {% for court_num, court in match_courts.items() %}
            <div class="col">
                <div class="card h-100 shadow-lg court-card">
                    <div class="card-header bg-success text-white text-center">
                        <h2 class="mb-0">ğŸ¾ ã‚³ãƒ¼ãƒˆ{{ court_num }}</h2>
                    </div>
                    <div class="card-body p-4">
                        <form class="score-form" 
                            data-court-number="{{ court_num }}"
                            id="score-form-{{ court_num }}"
                            action="{{ url_for('game.submit_score', match_id=match_id, court_number=court_num) }}">                            
                            
                            <!-- ãƒãƒ¼ãƒ A -->
                            <div class="score-row">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-danger me-3 team-badge">A</span>
                                        <span class="team-name">
                                            {% for player in court.team_a %}
                                                {{ player.display_name }}{% if not loop.last %} & {% endif %}
                                            {% endfor %}
                                        </span>
                                    </div>
                                    <div style="width: 200px;">                                
                                        <input type="number" name="team1_score" class="form-control score-input"
                                            required min="0" placeholder="0"
                                            inputmode="numeric" pattern="\d*">
                                    </div>
                                </div>
                            </div>

                            <!-- VSè¡¨ç¤º -->
                            <div class="text-center my-4">
                                <span class="vs-display">VS</span>
                            </div>

                            <!-- ãƒãƒ¼ãƒ B -->
                            <div class="score-row">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-primary me-3 team-badge">B</span>
                                        <span class="team-name">
                                            {% for player in court.team_b %}
                                                {{ player.display_name }}{% if not loop.last %} & {% endif %}
                                            {% endfor %}
                                        </span>
                                    </div>
                                    <div style="width: 200px;">                                
                                        <input type="number" name="team2_score" class="form-control score-input"
                                            required min="0" placeholder="0"
                                            inputmode="numeric" pattern="\d*">
                                    </div>                         
                                </div>
                            </div>
                                
                            <div class="text-center mt-5">
                                <button type="submit" class="btn btn-orange submit-btn">
                                    <i class="fas fa-trophy me-2"></i>ã‚¹ã‚³ã‚¢é€ä¿¡
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> ã‚³ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
        {% endif %}
    </div>

    <!-- è©¦åˆçµ‚äº†ãƒœã‚¿ãƒ³ -->
    <form method="POST" action="{{ url_for('game.finish_current_match') }}">
        <div class="text-center mt-5 mb-5">
            <button id="endMatchButton" type="submit" class="btn btn-danger btn-xl px-5 py-3 fs-2" disabled>
                <i class="fas fa-flag-checkered me-2"></i>è©¦åˆçµ‚äº†
            </button>
        </div>
    </form>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ -->
    <div class="text-center mb-5">
        <button id="debugButton" class="btn btn-secondary">ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const forms = document.querySelectorAll(".score-form");
        const formStatus = {};
        let submittedCount = 0;
        const totalForms = forms.length;
        
        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        if (totalForms === 0) {
            document.getElementById("no-data-message").style.display = "block";
        }
    
        // è©¦åˆçµ‚äº†ãƒœã‚¿ãƒ³ã‚’åˆæœŸçŠ¶æ…‹ã§ç„¡åŠ¹ã«
        const endButton = document.getElementById("endMatchButton");
        if (endButton) endButton.disabled = true;
    
        // å„ã‚¹ã‚³ã‚¢ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
        forms.forEach((form, index) => {
            const formId = form.getAttribute("id");
            formStatus[formId] = { submitted: false };
    
            form.addEventListener("submit", function (e) {
                e.preventDefault();
    
                const formData = new FormData(form);
                const actionUrl = form.getAttribute("action");
                
                // åŒç‚¹ãƒã‚§ãƒƒã‚¯
                const team1Score = parseInt(formData.get("team1_score"));
                const team2Score = parseInt(formData.get("team2_score"));
                
                if (team1Score === team2Score) {
                    alert("ã‚¹ã‚³ã‚¢ãŒåŒç‚¹ã§ã™ã€‚å‹è€…ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚");
                    return;
                }
    
                fetch(actionUrl, {
                    method: "POST",
                    body: formData,
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || "é€ä¿¡ã‚¨ãƒ©ãƒ¼");
                        });
                    }
                    return response;
                })
                .then(() => {
                    const submitBtn = form.querySelector("button[type='submit']");
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>é€ä¿¡æ¸ˆã¿';
                        submitBtn.classList.remove("btn-orange");
                        submitBtn.classList.add("submitted-btn");
                    }
    
                    formStatus[formId].submitted = true;
                    submittedCount++;
    
                    if (submittedCount === totalForms && endButton) {
                        console.log("âœ… å…¨ã‚¹ã‚³ã‚¢é€ä¿¡å®Œäº† â†’ è©¦åˆçµ‚äº†ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–");
                        endButton.disabled = false;
                    }
                })
                .catch(error => {
                    alert(error.message || "ã‚¹ã‚³ã‚¢é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    console.error(error);
                });
            });
        });
    
        // âœ… è©¦åˆçµ‚äº†ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚’è¿½åŠ 
        if (endButton) {
            endButton.addEventListener("click", function (e) {
                e.preventDefault();
                
                // ãƒœã‚¿ãƒ³ã‚’å³åº§ã«ç„¡åŠ¹åŒ–ï¼ˆé‡è¤‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ï¼‰
                endButton.disabled = true;
                endButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å‡¦ç†ä¸­...';

                fetch("/game/finish_current_match", {
                    method: "POST",
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'  // Ajaxåˆ¤å®šç”¨ãƒ˜ãƒƒãƒ€ãƒ¼
                    }
                })
                .then(res => res.json())  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
                .then(data => {
                    if (data.success) {
                        window.location.href = "/game/court";
                    } else {
                        throw new Error(data.error || "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    }
                })
                .catch(error => {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                    endButton.disabled = false;
                    endButton.innerHTML = '<i class="fas fa-flag-checkered me-2"></i>è©¦åˆçµ‚äº†';
                    alert(error.message || "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                    console.error(error);
                });
            });
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ã®è¨­å®š
        const debugButton = document.getElementById("debugButton");
        if (debugButton) {
            debugButton.addEventListener("click", function() {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                fetch("/game/debug_data")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("debug-data").textContent = JSON.stringify(data, null, 2);
                    document.getElementById("debug-info").style.display = "block";
                })
                .catch(error => {
                    console.error("ãƒ‡ãƒãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:", error);
                    document.getElementById("debug-data").textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: " + error.message;
                    document.getElementById("debug-info").style.display = "block";
                });
            });
        }

        // ã‚¹ã‚³ã‚¢å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
        document.querySelectorAll('.score-input').forEach(input => {
            input.addEventListener('focus', function() {
                this.style.transform = 'scale(1.05)';
                this.style.transition = 'transform 0.2s ease';
            });
            
            input.addEventListener('blur', function() {
                this.style.transform = 'scale(1)';
            });
        });
    });

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function toggleDebug() {
        const debugInfo = document.getElementById("debug-info");
        debugInfo.style.display = debugInfo.style.display === "none" ? "block" : "none";
    }
</script>

</body>
</html>