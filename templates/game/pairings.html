{% extends "base.html" %}

{% block content %}
<div class="container mt-5 pt-3">
  <h1>本日の試合組み合わせ</h1>
  
  <!-- 管理者用ペアリング実行ボタン -->
  {% if current_user.administrator %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <a href="{{ url_for('game.create_pairings') }}" class="btn btn-primary">
      ペアリングを実行する
    </a>
  </div>
  {% endif %}

  <!-- ユーザーの状態に応じたアクションボタン -->
  <div class="mb-4">
    {% if is_registered %}
      <div class="alert alert-success">
        あなたは参加登録中です。試合開始までお待ちください。
      </div>
      <div class="btn-group">
        <a href="{{ url_for('game.cancel') }}" class="btn btn-outline-danger">
          <i class="fas fa-sign-out-alt"></i> コートから出る
        </a>
        <a href="{{ url_for('game.rest') }}" class="btn btn-outline-warning">
          <i class="fas fa-coffee"></i> 休憩する
        </a>
      </div>
    {% elif is_resting %}
      <div class="alert alert-warning">
        あなたは休憩中です。
      </div>
      <div class="btn-group">
        <a href="{{ url_for('game.register') }}" class="btn btn-outline-success">
          <i class="fas fa-play"></i> 再開する
        </a>
        <a href="{{ url_for('game.cancel') }}" class="btn btn-outline-danger">
          <i class="fas fa-times"></i> 完全にキャンセル
        </a>
      </div>
    {% else %}
      <div class="alert alert-info">
        参加するには「コートに入る」ボタンを押してください。
      </div>
      <a href="{{ url_for('game.register') }}" class="btn btn-success">
        <i class="fas fa-sign-in-alt"></i> コートに入る
      </a>
    {% endif %}
  </div>

  <!-- 参加待ちプレイヤー一覧 -->
  <h3>参加待ちプレイヤー ({{ pending_players|length }}人)</h3>
  <div class="list-group mb-4">
    {% for player in pending_players %}
      <div class="list-group-item d-flex justify-content-between align-items-center">
        {{ player.display_name }}
        <span class="badge bg-primary">{{ player.badminton_experience }}</span>
      </div>
    {% else %}
      <div class="list-group-item">参加待ちプレイヤーはいません</div>
    {% endfor %}
  </div>

  <!-- 休憩中プレイヤー一覧 -->
  <h3>休憩中プレイヤー ({{ resting_players|length }}人)</h3>
  <div class="list-group mb-4">
    {% for player in resting_players %}
      <div class="list-group-item d-flex justify-content-between align-items-center">
        {{ player.display_name }}
        <span class="badge bg-warning text-dark">{{ player.badminton_experience }}</span>
      </div>
    {% else %}
      <div class="list-group-item">休憩中のプレイヤーはいません</div>
    {% endfor %}
  </div>
<!-- 試合が存在するかどうか -->
{% if matches and matches|length > 0 %}
  <h3>現在の試合 (マッチID: {{ match_id|default('なし') }})</h3>







  {% for match in matches %}
    <div class="card mb-3" id="court-{{ match.court }}">
      <div class="card-header bg-primary text-white">
        コート {{ match.court }}
      </div>
      <div class="card-body">
        <form class="score-form" data-court="{{ match.court }}">
          <input type="hidden" name="match_id" value="{{ match_id }}">
          <input type="hidden" name="court_number" value="{{ match.court }}">

          <div class="row">
            <!-- チームA -->
            <div class="col-md-6">
              <h5 class="text-danger">チームA</h5>
              <ul>
                {% for player in match.teamA %}
                  <li>{{ player.display_name }}</li>
                {% endfor %}
              </ul>
              <input type="number" name="score_team_a" placeholder="チームAスコア" required>
            </div>

            <!-- チームB -->
            <div class="col-md-6">
              <h5 class="text-info">チームB</h5>
              <ul>
                {% for player in match.teamB %}
                  <li>{{ player.display_name }}</li>
                {% endfor %}
              </ul>
              <input type="number" name="score_team_b" placeholder="チームBスコア" required>
            </div>
          </div>

          <div class="mt-3">
            <button type="submit" class="btn btn-success btn-sm">スコア送信</button>
            <span class="status-msg text-success ms-2"></span>
          </div>
        </form>
      </div>
    </div>
  {% endfor %}




      <!-- ✅ コート単位で1つだけスコア入力フォーム -->
      <form method="POST" action="{{ url_for('game.submit_score', match_id=match_id, court_number=match.court) }}" class="mt-3">
        <div class="row">
          <div class="col-md-3">
            <input type="number" name="score_team_a" class="form-control" placeholder="チームAスコア" required>
          </div>
          <div class="col-md-3">
            <input type="number" name="score_team_b" class="form-control" placeholder="チームBスコア" required>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-sm btn-success">スコア送信</button>
          </div>
        </div>
      </form>
    </div>
  </div>
{% endfor %}

  {% if rest and rest|length > 0 %}
    <h4>試合に参加できなかったプレイヤー</h4>
    <div class="list-group mb-4">
      {% for player in rest %}
        <div class="list-group-item">
          {{ player.display_name }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% else %}
  <div class="alert alert-info">
    まだ試合の組み合わせが作成されていません。
  </div>
{% endif %}


<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".score-form").forEach(form => {
    form.addEventListener("submit", async function(event) {
      event.preventDefault();

      const formData = new FormData(form);
      const courtNumber = form.dataset.court;
      const response = await fetch("/submit_score", {
        method: "POST",
        body: formData
      });

      const result = await response.json();
      const statusMsg = form.querySelector(".status-msg");
      if (result.success) {
        statusMsg.textContent = `✅ コート${courtNumber} スコア登録完了`;
      } else {
        statusMsg.textContent = `⚠️ 登録失敗: ${result.message}`;
        statusMsg.classList.remove("text-success");
        statusMsg.classList.add("text-danger");
      }
    });
  });
});
</script>


</div>
{% endblock %}