{% extends "base.html" %}

{# SEO最適化 #}
{% block title %}鶯 | 越谷市バドミントンサークル{% endblock %}
{% block description %}埼玉県越谷市で活動しているバドミントンサークルです。経験者から初心者まで楽しく活動中。見学・体験随時募集中。{% endblock %}
{% block keywords %}埼玉県,越谷市, バドミントン, サークル, 練習, 見学, 体験{% endblock %}

{% block content %}  

<style>
/* indexのスケジュール領域だけに限定して上書き */
#schedule .accordion-button::after {
  display: none !important;  /* アコーディオンの矢印を非表示 */
}

#schedule .accordion-header{
  background-color: #ffffff;
  padding: 0;          /* 100 は無効だったため 0 に修正（必要なら 10px などに） */
  margin: 5px;         /* 単位を付与 */
}

#schedule .accordion-button{
  background-color: #ffffff;
  padding: 0;
  margin: 0;
  font-size: 1.2rem;
}

#schedule .accordion-item{
  background-color: #ffffff;
  padding: 5px;
  margin: 5px;
  border: 1px solid rgba(0,0,0,.125);
  border-radius: 0.25rem !important;
}

/* レスポンシブ調整：#schedule 配下に限定（フッターの .d-flex には当たらない） */
@media (max-width: 768px) {
  #schedule .d-flex {    
    align-items: flex-start !important;
    gap: 0.5rem;
  }
}

/* そのほかの装飾 */
#schedule .participant-name{
  z-index: 1000;
  position: relative;
  pointer-events: auto;
}
</style>

<style>
    .avatar-ig{
        --size: 28px;   /* 画像の直径 */
        --ring: 2px;    /* グラデリングの太さ */
        --gap: 1px;     /* 画像とリングの間の白い縁 */
        display:inline-grid; place-items:center;
        width:calc(var(--size) + (var(--ring)+var(--gap))*2);
        height:calc(var(--size) + (var(--ring)+var(--gap))*2);
        border-radius:50%;
        padding:calc(var(--ring) + var(--gap));
        background:conic-gradient(#feda75,#fa7e1e,#d62976,#962fbf,#4f5bd5,#feda75);
    }
    .avatar-ig>img{
        width:var(--size); height:var(--size);
        border-radius:50%; object-fit:cover; display:block;
        background:#fff; box-shadow:0 0 0 var(--gap) #fff;
    }
</style>


<style>
.search-box {

        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 8px;        
        margin: 0 auto 50px auto;
        width: 90%;
    }
    
    .qa-input-container {
        position: relative;
    }
    
    .qa-input {
        width: 100%;
        padding: 15px;
        border: 2px solid #007bff;
        border-radius: 8px;
        font-size: 16px;
        resize: vertical;
        min-height: 80px;
    }
    
    .qa-input:focus {
        outline: none;
        border-color: #0056b3;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .ugumanager-response {
        background-color: white;
        border: 2px solid #28a745;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .response-header {
        font-weight: bold;
        color: #28a745;
        margin-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }
    
    .response-content {
        line-height: 1.7;
        color: #495057;
    }

    .image-wrap {
  text-align: center;
  margin: 20px auto;
  width: 100%;
  max-width: 480px; /* スマホでも中央で安定する */
    }

    .image-wrap img.tournament-image {
    width: 100%;        /* 親幅に合わせて可変 */
    height: auto;       /* 比率を維持 */
    display: block;     /* 中央揺れ防止 */
    border-radius: 6px; /* 任意 */
    }

</style>

<div class="image-wrap">
  <img src="{{ url_for('static', filename='images/top008.jpg') }}"
       class="tournament-image"
       alt="第2回鶯バドミントン大会（2025年）集合写真｜越谷市で開催"
       loading="eager" fetchpriority="high">
</div>




<div class="container">       
    <section id="schedule" class="mb-5">                        
        <div class="schedule text-center">
                      
            {% if not current_user.is_authenticated %}
            <div class="mt-3">
                <p>練習に参加するには仮登録しログインして、参加ボタンを押してください。
                <a href="{{ url_for('temp_register') }}" class="btn btn-warning">仮登録へ</a></p>
                <p>募集中であれば参加できます。初参加の方はmailかLINEでご連絡いただけると助かります</p>
            </div>
            {% endif %}           
           
            
            
       
        <div class="d-flex flex-column align-items-center gap-3 mb-4">
        <!-- LINEボタン -->
        <a href="https://line.me/ti/p/gErDAMJEId" 
        target="_blank" 
        rel="noopener noreferrer" 
        class="btn" 
        style="background-color: #00B900; color: white; font-size: 1.5rem; width: 100%; max-width: 100%;">
            <b>LINEで連絡 ココをクリック</b>
        </a>        
        <!-- うぐすたぐらむボタン -->
        <a href="{{ url_for('uguu.show_timeline') }}" 
        class="btn" 
        style="background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); 
                color: white; 
                font-size: 1.5rem; 
                width: 100%; 
                max-width: 100%;
                border: none;
                box-shadow: 0 4px 15px rgba(188, 24, 136, 0.3);">
            <b><i class="fas fa-camera-retro me-2"></i>うぐすたぐらむ</b>
        </a>
    </div>


            <div class="schedule-title d-flex flex-column flex-md-row align-items-center justify-content-center text-center gap-2 mb-3">
                <h2 class="m-0">練習予定</h2>
                <a href="{{ url_for('schedule_koyomi') }}"
                class="btn btn-warning mx-2">
                    全ての予定＆カレンダー
                </a>
            </div>
           

                <!-- アコーディオン（修正版） -->
                <div class="accordion" id="scheduleAccordion">
                {% for schedule in schedules %}
                <div class="accordion-item">

                    {% if schedule.comment %}
                    <div class="mb-2 text-center">
                        <div class="fw-bold text-warning">
                        <i class="fas fa-info-circle me-1"></i>{{ schedule.comment }}
                        </div>
                    </div>
                    {% endif %}



                               
                                
                                





                    <!-- ヘッダー行：左 = 折りたたみボタン / 右 = 操作ボタン -->
                    <div class="d-flex align-items-center justify-content-between flex-nowrap gap-2 px-2 pt-2">
                     <h2 class="accordion-header" id="heading{{ schedule.schedule_id }}">                   


                        {% if current_user.is_authenticated and current_user.administrator %}  
                        
                        <button class="accordion-button collapsed py-2 px-2"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapse{{ schedule.schedule_id }}"
                                aria-expanded="false"
                                aria-controls="collapse{{ schedule.schedule_id }}"
                                style="box-shadow:none;">
                        <div class="d-flex w-100 align-items-center justify-content-between gap-2">
                            <div class="d-flex align-items-center flex-grow-1" style="min-width:0;">
                            <span class="me-2">
                                {{ schedule.date | format_date }}({{ schedule.day_of_week }})
                                {{ schedule.start_time }} ~ {{ schedule.end_time }}<br>
                                {{ schedule.venue }}{{ schedule.court }}   

                            </div>
                            <div class="text-end">
                            募集 {{ schedule.participants_count }}/{{ schedule.max_participants }}
                            {% if schedule.participants_count >= schedule.max_participants %}
                                <span class="badge bg-warning text-dark">満員御礼</span>
                            {% else %}
                                <span class="badge bg-success">募集中</span>
                            {% endif %}
                            </div>
                        </div>
                        </button>
                        {% else %}
                        <!-- 一般ユーザーは開閉不可のダミーボタン（disabled） -->
                        <button class="accordion-button collapsed py-2 px-2" type="button" disabled style="cursor:default; box-shadow:none;">
                        <div class="d-flex w-100 align-items-center justify-content-between gap-2">
                            <div class="d-flex align-items-center flex-grow-1">
                            <span class="me-2">
                                {{ schedule.date | format_date }}({{ schedule.day_of_week }})
                                {{ schedule.start_time }} ~ {{ schedule.end_time }}<br>
                                {{ schedule.venue }}{{ schedule.court }}
                            </span>
                            </div>
                            <div class="text-end">
                            募集人数 {{ schedule.participants_count }}/{{ schedule.max_participants }}
                            {% if schedule.participants_count >= schedule.max_participants %}
                                <span class="badge bg-warning text-dark">満員御礼</span>
                            {% else %}
                                <span class="badge bg-success">募集中</span>
                            {% endif %}
                            </div>
                        </div>
                        </button>
                        {% endif %}
                    </h2>

                    <!-- 操作ボタン群（h2の外・右側） -->
                    <div class="d-flex align-items-center flex-nowrap gap-2 flex-shrink-0 ms-2">
                        <!-- 参加 -->
                        <button
                        class="btn btn-sm join-button text-nowrap
                            {% if not current_user.is_authenticated %}
                            btn-secondary
                            {% elif schedule.participants_count >= schedule.max_participants and current_user.id not in schedule.participants %}
                            btn-secondary
                            {% elif current_user.id in schedule.participants %}
                            btn-danger
                            {% else %}
                            btn-primary
                            {% endif %}"
                        {% if not current_user.is_authenticated or
                                (schedule.participants_count >= schedule.max_participants and
                                current_user.id not in schedule.participants) %}disabled{% endif %}
                        data-schedule-id="{{ schedule.schedule_id }}"
                        data-schedule-date="{{ schedule.date }}"
                        onclick="joinSchedule(this)">
                        {% if not current_user.is_authenticated %}
                            参加
                        {% elif schedule.participants_count >= schedule.max_participants and current_user.id not in schedule.participants %}
                            満員御礼
                        {% elif current_user.id in schedule.participants %}
                            参加済
                        {% else %}
                            参加
                        {% endif %}
                        </button>

                        <!-- たら -->
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-sm text-nowrap
                                {% if current_user.id in schedule.get('tara_participants', []) %}
                                btn-warning
                                {% else %}
                                btn-outline-warning
                                {% endif %}"
                                data-schedule-id="{{ schedule.schedule_id }}"
                                data-schedule-date="{{ schedule.date }}"
                                onclick="taraSchedule(this)">
                        {% if current_user.id in schedule.get('tara_participants', []) %}たら済 ✓{% else %}たら{% endif %}
                        </button>
                        {% else %}
                        <button class="btn btn-sm text-nowrap btn-secondary" disabled>たら</button>
                        {% endif %}
                    </div>
                   
                    </div>

                      {# ログインしているときだけ表示する #}
                            {% if current_user.is_authenticated %}
                            {# participants_info が無ければ [] にする #}
                            {% set plist = schedule.participants_info | default([]) %}
                            {% if plist %}
                                <div class="mt-1 d-flex align-items-center flex-wrap gap-1">
                                {% for p in plist[:7] %}
                                    <span class="avatar-ig" style="--size:28px;--ring:2px;--gap:1px;" title="{{ p.display_name }}">
                                    <img
                                        src="{{ p.profile_image_url or url_for('static', filename='images/default.jpg') }}"
                                        alt="{{ p.display_name }}"
                                        width="28" height="28" loading="lazy" decoding="async"
                                        class="rounded-circle" style="object-fit:cover;"
                                        onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/default.jpg') }}'">
                                    </span>
                                {% endfor %}
                                {% if plist|length > 7 %}
                                    <span class="badge bg-secondary ms-1">+{{ plist|length - 7 }}</span>
                                {% endif %}
                                </div>
                            {% endif %}
                            {% endif %}

                    {% if current_user.is_authenticated and current_user.administrator %}
                    <div id="collapse{{ schedule.schedule_id }}"
                        class="accordion-collapse collapse"
                        aria-labelledby="heading{{ schedule.schedule_id }}"
                        data-bs-parent="#scheduleAccordion">
                    <div class="accordion-body">
                        <!-- 参加者一覧など（元のまま） -->
                        <div class="text-start">
                        <h5 class="mb-3">
                            <!-- Bootstrap Icons を使うなら CDN 読み込み要。無ければ Font Awesome に置換を -->
                            <i class="bi bi-people-fill text-primary"></i>
                            <a href="{{ url_for('day_of_participants', date=schedule.date) }}" class="text-decoration-none text-dark">
                            参加者一覧 ({{ schedule.participants_count }}人)
                            </a>
                        </h5>
                        {% if schedule.participants_info %}
                        <div class="row">
                        {% for participant in schedule.participants_info %}
                        <div class="col-md-3 col-sm-4 mb-1">
                            <div class="card">
                                <div class="card-body py-2 d-flex justify-content-between align-items-center">
                                    <a href="{{ url_for('users.user_profile', user_id=participant.get('user_id') or participant.get('user#user_id')) }}"
                                    class="participant-name text-decoration-none text-dark flex-grow-1">
                                        {{ participant.display_name }}
                                    </a>
                                    <!-- 削除ボタン -->
                                    <button class="btn btn-sm btn-danger ms-2" 
                                            onclick="removeParticipant('{{ schedule.schedule_id }}', '{{ participant.get('user_id') or participant.get('user#user_id') }}', '{{ schedule.date }}')"
                                            title="参加者を削除">
                                        ×
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">まだ参加者がいません</p>
                        {% endif %}

                        {% if schedule.tara_participants_info %}
                        <h5 class="mb-3 mt-4">
                        <i class="bi bi-question-circle text-warning"></i>
                        たら ({{ schedule.tara_count }}人)
                        </h5>
                        <div class="row">
                        {% for tara_participant in schedule.tara_participants_info %}
                        <div class="col-md-3 col-sm-4 mb-1">
                            <div class="card border-warning">
                            <div class="card-body py-2">
                                <a
                                href="{{ url_for('users.user_profile', user_id=tara_participant.get('user_id') or tara_participant.get('user#user_id')) }}"
                                class="participant-name text-warning text-decoration-none"
                                >
                                {{ tara_participant.display_name }}
                                </a>
                            </div>
                            </div>
                        </div>
                        {% endfor %}
                        </div>
                        {% else %}
                        <h5 class="mb-2 mt-4">
                        <i class="bi bi-question-circle text-warning"></i>たら (0人)
                        </h5>
                        <p class="text-muted">たらはいません</p>
                        {% endif %}
                        </div>
                    </div>
                    </div>
                    {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>

        <section id="about" class="mt-1 mb-1 text-center">

            <h2 class="mb-3">バドミントンメンバー募集</h2>
            <p>初級者～上級者レベルが違っても楽しくゲームできる方<br>
            小中学生、未経験者はご相談ください<br>
                        </p>
            
                        <div class="row justify-content-center">  
                            <div class="col-12 col-md-8 text-center">  
                                <div>
                                    <h3>参加費</h3>
                                    <p>初回1200円、2回目以降 男性800円 女性600円<br>
                                        大学生、高校生600円 中学生以下500円<br>
                                    未経験から15回は 鶯 Boot Camp15 1回1000円</p>
                                </div>
                                <h3>練習場所</h3>
                                <div class="mb-3">            
                                    <p><b>北越谷体育館 越谷市立地域スポーツセンター</b><br>
                                    〒343-0025 埼玉県越谷市大沢二丁目10番21号<br>
                                    北越谷駅東口 徒歩7分</p>
                                </div>
                                <div>            
                                    <p><b>越谷市立総合体育館 第一体育室または第二体育室</b><br>
                                    〒343-0011埼玉県越谷市増林ニ丁目33番地<br></p>
                                </div>
                            </div>
                        </div>


        <div class="container">                


        </section>      

            <!-- AI質問ボックス -->
        <div class="search-box">
            <h3>ご質問はこちら</h3>            
            <div class="qa-input-container">
                <textarea class="qa-input" placeholder="質問を入力（例：「10年ほどブランクがありますが、参加できますか？」「初めての参加です、何をもっていったらいいですか？」など）" id="ugumanager-question" rows="3"></textarea>
                <div class="text-center">
                <button class="btn btn-primary mt-2" id="ask-ugumanager">鶯マネージャーに質問する</button>
            </div>
            </div>
            <div id="ugumanager-response" class="ugumanager-response" style="display: none;">
                <div class="response-header">
                    <strong>鶯マネの回答:</strong>
                    <button class="btn btn-sm btn-outline-secondary float-end" id="save-qa">この回答をQ&Aに追加</button>
                </div>
                <div class="response-content" id="response-text"></div>
            </div>            
        </div>  

        <section id="contact" class="mb-5 text-center">        

            <section class="mb-2 text-center">
            渋谷: <a href="tel:07066330363">070-6633-0363</a><br>
            e-mail: <a href="mailto:shibuyamasahiko@gmail.com">shibuyamasahiko@gmail.com</a>       
        </section>
            <section class="text-center">
            <a href="https://x.com/rbn17pjAfz41575" target="_blank" rel="noopener noreferrer" class="btn btn-primary me-2">X（旧Twitter）</a>
            <a href="https://www.instagram.com/kosigayabadminton/" target="_blank" rel="noopener noreferrer" class="btn btn-info">Instagram</a>
            </section>
        
            
        </section>         
            
        </div>   
    </div>

<script>
    let isJoining = false;
    let isTaraJoining = false;

    async function joinSchedule(button) {

            // ↓↓↓ この4行を追加 ↓↓↓
        if (isJoining) {
            console.log('参加処理中です');
            return;
        }
        // ↑↑↑ ここまで追加 ↑↑↑
        
        const scheduleId = button.getAttribute('data-schedule-id');
        const scheduleDate = button.getAttribute('data-schedule-date');

        if (!scheduleId || !scheduleDate) {
            alert('スケジュール情報が不足しています。');
            return;
        }

        // ↓↓↓ この4行を追加 ↓↓↓
        isJoining = true;
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = '処理中...';
        // ↑↑↑ ここまで追加 ↑↑↑


        try {
            const response = await fetch(`/schedule/${scheduleId}/join`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ date: scheduleDate })
            });

            if (!response.ok) {
                const errorData = await response.json();
                alert(errorData.message || 'エラーが発生しました');
                // ↓↓↓ ここにリセット処理を追加 ↓↓↓
                isJoining = false;
                button.disabled = false;
                button.textContent = originalText;
                // ↑↑↑ ここまで追加 ↑↑↑
                return;
            }

            const data = await response.json();

            if (data.message) {
                alert(data.message);
            }

            // ページをリロードして変更を反映
            location.reload();

        } catch (error) {
            console.error('Fetch error:', error);
            alert('通信エラーが発生しました');
            // ↓↓↓ この3行を追加 ↓↓↓
            isJoining = false;
            button.disabled = false;
            button.textContent = originalText;
            // ↑↑↑ ここまで追加 ↑↑↑
        }
    }

    // ★ 「たら」参加機能を追加
    async function taraSchedule(button) {

        if (isTaraJoining) {
            console.log('「たら」参加処理中です');
            return;
        }

        const scheduleId = button.getAttribute('data-schedule-id');
        const scheduleDate = button.getAttribute('data-schedule-date');

        if (!scheduleId || !scheduleDate) {
            alert('スケジュール情報が不足しています。');
            return;
        }

        // ↓↓↓ この4行を追加 ↓↓↓
        isTaraJoining = true;
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = '処理中...';
        // ↑↑↑ ここまで追加 ↑↑↑


        try {
            const response = await fetch('/tara_join', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ 
                    schedule_id: scheduleId,
                    schedule_date: scheduleDate 
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                alert(errorData.message || 'エラーが発生しました');
                return;
            }

            const data = await response.json();

            if (data.message) {
                alert(data.message);
            }

            // ページをリロードして変更を反映
            location.reload();

        } catch (error) {
            console.error('「たら」参加処理エラー:', error);
            alert('通信エラーが発生しました');

            // ↓↓↓ この3行を追加 ↓↓↓
            isTaraJoining = false;
            button.disabled = false;
            button.textContent = originalText;
            // ↑↑↑ ここまで追加 ↑↑↑

        }
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // 設定: バドマネージャーのURL（HTTPS）
    const API_BASE_URL = 'https://bad-manager.shibuya8020.com'; // 本番環境
    // const API_BASE_URL = 'http://127.0.0.1:7861'; // ローカル開発環境
    
    const questionInput = document.getElementById('ugumanager-question');
    const askButton = document.getElementById('ask-ugumanager');
    const responseDiv = document.getElementById('ugumanager-response');
    const responseText = document.getElementById('response-text');
    const saveQAButton = document.getElementById('save-qa');

    // バドマネージャーに質問を送信する関数（Gradio API対応）
    async function askBadManager(question) {
        try {
            // ローディング表示
            askButton.disabled = true;
            askButton.textContent = '回答生成中...';
            responseDiv.style.display = 'none';
            
            console.log('POST リクエスト送信:', {
                url: `${API_BASE_URL}/call/respond_badminton`,
                data: [question, []]
            });

            // タイムアウト設定（60秒 - AI処理時間を考慮）
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);
            
            // Step 1: POST リクエストでevent_idを取得
            const postResponse = await fetch(`${API_BASE_URL}/gradio_api/call/respond_badminton`, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: [question, []], // [msg, chatbot] に対応
                    fn_index: 0
                }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!postResponse.ok) {
                throw new Error(`POST リクエスト失敗: ${postResponse.status} ${postResponse.statusText}`);
            }

            const postData = await postResponse.json();
            const eventId = postData.event_id;
            console.log('取得したevent_id:', eventId);

            if (!eventId) {
                throw new Error('event_idが取得できませんでした');
            }

            // Step 2: GET リクエストで結果を取得（ストリーミング）
            const getResponse = await fetch(`${API_BASE_URL}/gradio_api/call/respond_badminton/${eventId}`, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'text/event-stream',
                }
            });

            if (!getResponse.ok) {
                throw new Error(`GET リクエスト失敗: ${getResponse.status} ${getResponse.statusText}`);
            }

            // Server-Sent Eventsを処理
            const reader = getResponse.body.getReader();
            const decoder = new TextDecoder();
            let result = '';
            let isComplete = false;

            askButton.textContent = 'AI処理中...';

            while (!isComplete) {
                const { done, value } = await reader.read();
                
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('event: complete')) {
                        isComplete = true;
                    } else if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            console.log('受信データ:', data);
                            
                            // Gradio Chatbotの戻り値は [msg, chatbot] 形式
                            if (Array.isArray(data) && data.length >= 2) {
                                const updatedMsg = data[0]; // 空文字が返される
                                const chatHistory = data[1]; // chatbot履歴
                                
                                if (Array.isArray(chatHistory) && chatHistory.length > 0) {
                                    // 最後のアシスタントメッセージを取得
                                    const lastMessage = chatHistory[chatHistory.length - 1];
                                    if (lastMessage && typeof lastMessage === 'object') {
                                        if (lastMessage.role === 'assistant') {
                                            result = lastMessage.content;
                                        } else if (lastMessage.content) {
                                            // 旧形式の場合の対応
                                            result = lastMessage.content;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('データ解析エラー:', e, 'ライン:', line);
                        }
                    }
                }
            }

            if (result) {
                responseText.innerHTML = formatResponse(result);
                responseDiv.style.display = 'block';
                
                responseDiv.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
                
                return result;
            } else {
                throw new Error('バドマネージャーから有効な回答を取得できませんでした');
            }

        } catch (error) {
            console.error('Error:', error);
            
            let errorMessage = '予期しないエラーが発生しました';
            
            if (error.name === 'AbortError') {
                errorMessage = 'リクエストがタイムアウトしました（60秒）';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'バドマネージャーサーバーに接続できませんでした';
            } else {
                errorMessage = error.message;
            }
            
            responseText.innerHTML = `
                <div class="alert alert-danger">
                    <strong>エラー:</strong> ${errorMessage}
                    <br><small>バドマネージャーサーバーが正常に動作しているか確認してください。</small>
                    <br><small>エンドポイント: ${API_BASE_URL}/gradio_api/call/respond_badminton</small>
                </div>
            `;
            responseDiv.style.display = 'block';
            
        } finally {
            askButton.disabled = false;
            askButton.textContent = 'バドマネージャーに質問する';
        }
    }

    // 回答をHTML形式でフォーマットする関数
    function formatResponse(response) {
        if (!response || response.trim() === '') {
            return '<div class="alert alert-warning">回答が空です。</div>';
        }
        
        // HTMLエスケープしてからフォーマット
        let formatted = response
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            // **太字** を <strong> に変換
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // *イタリック* を <em> に変換
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // 改行を <br> に変換
            .replace(/\n/g, '<br>')
            // リスト項目（- で始まる行）を整理
            .replace(/^- (.+)/gm, '• $1')
            // 数字付きリスト
            .replace(/^\d+\. (.+)/gm, '<div style="margin-left: 20px;">$&</div>');
        
        return `<div class="response-content">${formatted}</div>`;
    }

    // 質問ボタンのクリックイベント
    askButton.addEventListener('click', async function() {
        const question = questionInput.value.trim();
        
        if (!question) {
            alert('質問を入力してください。');
            questionInput.focus();
            return;
        }

        if (question.length > 1000) {
            alert('質問が長すぎます。1000文字以内で入力してください。');
            return;
        }

        await askBadManager(question);
    });

    // Enterキーでの送信（Shift+Enterは改行）
    questionInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            if (!askButton.disabled) {
                askButton.click();
            }
        }
    });

    // タグクリック時の質問自動入力
    document.querySelectorAll('.tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const question = this.dataset.question;
            if (question) {
                questionInput.value = question;
                questionInput.focus();
                // 自動的に質問を送信
                askButton.click();
            }
        });
    });

    // Q&Aに追加するボタンのイベント
    saveQAButton.addEventListener('click', async function() {
        const question = questionInput.value.trim();
        const answerElement = responseText.querySelector('.response-content');
        const answer = answerElement ? (answerElement.textContent || answerElement.innerText) : '';
        
        if (!question || !answer) {
            alert('質問と回答の両方が必要です。');
            return;
        }
        
        // ボタンを無効化
        saveQAButton.disabled = true;
        const originalText = saveQAButton.textContent;
        saveQAButton.textContent = '保存中...';
        
        try {
            await saveToQASystem(question, answer);
        } finally {
            // ボタンを有効化
            saveQAButton.disabled = false;
            saveQAButton.textContent = originalText;
        }
    });

    // Q&Aシステムへの保存
    async function saveToQASystem(question, answer) {
        try {
            const response = await fetch('/admin/api/save-qa', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    answer: answer,
                    source: 'badmanager',
                    timestamp: new Date().toISOString()
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP エラー: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                showTemporaryMessage('Q&Aに追加されました！', 'success');
            } else {
                throw new Error(data.error || '保存に失敗しました');
            }
            
        } catch (error) {
            console.error('Save error:', error);
            showTemporaryMessage(`保存エラー: ${error.message}`, 'error');
        }
    }

    // 一時的なメッセージ表示
    function showTemporaryMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
        messageDiv.textContent = message;
        messageDiv.style.position = 'fixed';
        messageDiv.style.top = '20px';
        messageDiv.style.right = '20px';
        messageDiv.style.zIndex = '9999';
        messageDiv.style.maxWidth = '300px';
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 3000);
    }

    // バドマネージャーの稼働状況をチェックする関数
    async function checkBadManagerStatus() {
        try {
            const response = await fetch(`${API_BASE_URL}/`, {
                method: 'GET',
                timeout: 5000
            });
            
            return response.status === 200;
            
        } catch (error) {
            console.warn('Bad manager health check failed:', error);
            return false;
        }
    }

    // 初期化時にバドマネージャーの状態をチェック
    checkBadManagerStatus().then(isHealthy => {
        if (!isHealthy) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'alert alert-warning';
            warningDiv.innerHTML = `
                <strong>注意:</strong> バドマネージャーサーバーに接続できません。
                <br><small>サーバーが起動していることを確認してください。</small>
                <br><small>URL: ${API_BASE_URL}</small>
            `;
            
            const searchBox = document.querySelector('.search-box');
            const inputContainer = document.querySelector('.qa-input-container');
            searchBox.insertBefore(warningDiv, inputContainer);
        } else {
            console.log('✅ バドマネージャーが正常に動作しています');
        }
    });

    // ページ離脱時の確認
    window.addEventListener('beforeunload', function(event) {
        const question = questionInput.value.trim();
        if (question && question.length > 10) {
            event.preventDefault();
            return '入力中の質問が失われる可能性があります。';
        }
    });
});

// 管理者が参加者を削除する関数
async function removeParticipant(scheduleId, userId, scheduleDate) {
    if (!confirm('この参加者を削除しますか？')) {
        return;
    }

    try {
        const response = await fetch(`/schedule/${scheduleId}/participant/${userId}/remove`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ date: scheduleDate })
        });

        if (!response.ok) {
            const errorData = await response.json();
            alert(errorData.message || 'エラーが発生しました');
            return;
        }

        const data = await response.json();

        if (data.status === 'success') {
            alert(data.message);
            location.reload(); // ページをリロード
        } else {
            alert(data.message || '削除に失敗しました');
        }

    } catch (error) {
        console.error('削除エラー:', error);
        alert('通信エラーが発生しました');
    }
}
    </script>

        
{% endblock %}