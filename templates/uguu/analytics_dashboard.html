<!-- templates/uguu/analytics_dashboard.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>参加分析ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --primary-color: #4A90E2;
      --secondary-color: #7B68EE;
      --success-color: #50C878;
      --warning-color: #FFA500;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      --card-shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.12);
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }

    .header-section {
      background: var(--bg-gradient);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .header-section h1 {
      font-weight: 700;
      font-size: 2rem;
      margin: 0;
    }

    .header-section .user-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.95rem;
    }

    /* KPIカード */
    .kpi-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      height: 100%;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: none;
      position: relative;
      overflow: hidden;
    }

    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-shadow-hover);
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--bg-gradient);
    }

    .kpi-card.primary::before { background: linear-gradient(90deg, #4A90E2, #357ABD); }
    .kpi-card.success::before { background: linear-gradient(90deg, #50C878, #3DA35D); }
    .kpi-card.warning::before { background: linear-gradient(90deg, #FFA500, #FF8C00); }
    .kpi-card.info::before { background: linear-gradient(90deg, #7B68EE, #6A5ACD); }

    .kpi-icon {
      font-size: 2.5rem;
      opacity: 0.15;
      position: absolute;
      right: 1rem;
      top: 1rem;
    }

    .kpi-card.primary .kpi-icon { color: #4A90E2; }
    .kpi-card.success .kpi-icon { color: #50C878; }
    .kpi-card.warning .kpi-icon { color: #FFA500; }
    .kpi-card.info .kpi-icon { color: #7B68EE; }

    .kpi-label {
      font-size: 0.9rem;
      color: #6c757d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }

    .kpi-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #2c3e50;
      line-height: 1.2;
    }

    .kpi-subtitle {
      font-size: 0.85rem;
      color: #95a5a6;
      margin-top: 0.5rem;
    }

    .kpi-detail {
      font-size: 0.9rem;
      color: #34495e;
      margin-top: 0.3rem;
    }

    /* チャートカード */
    .chart-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: none;
    }

    .chart-card:hover {
      box-shadow: var(--card-shadow-hover);
    }

    .chart-container {
      position: relative;
      height: 280px;
      width: 100%;
    }

    .chart-container-large {
      position: relative;
      height: 320px;
      width: 100%;
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-title i {
      color: var(--primary-color);
    }

    .chart-toolbar {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-chart {
      border-radius: 20px;
      padding: 0.35rem 1rem;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      border: 2px solid #e0e0e0;
      background: white;
      color: #6c757d;
    }

    .btn-chart:hover {
      background: var(--bg-gradient);
      color: white;
      border-color: transparent;
      transform: scale(1.05);
    }

    .btn-chart.active {
      background: var(--bg-gradient);
      color: white;
      border-color: transparent;
    }

    /* 参加日一覧 */
    .dates-card {
      background: white;
      border-radius: 15px;
      box-shadow: var(--card-shadow);
      border: none;
      overflow: hidden;
    }

    .dates-card .card-header {
      background: var(--bg-gradient);
      color: white;
      padding: 1rem 1.5rem;
      border: none;
      font-weight: 600;
    }

    .dates-card .card-body {
      padding: 1.5rem;
    }

    .dates-month-title {
      font-size: 1rem;
      font-weight: 700;
      color: #4A90E2;
      margin-top: 1rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e9ecef;
    }

    .dates-month-title:first-child {
      margin-top: 0;
    }

    .dates-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.4rem 0.9rem;
      margin: 0.3rem;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      font-weight: 500;
    }

    .dates-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
      color: white;
    }

    .dates-badge:active {
      transform: translateY(0);
    }

    /* レスポンシブ調整 */
    @media (max-width: 768px) {
      .header-section h1 {
        font-size: 1.5rem;
      }
      
      .kpi-value {
        font-size: 1.8rem;
      }

      .chart-container {
        height: 240px;
      }

      .chart-container-large {
        height: 280px;
      }
    }

    /* ローディングアニメーション */
    .loading {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4A90E2;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* アラート */
    .alert-custom {
      border-radius: 15px;
      border: none;
      box-shadow: var(--card-shadow);
    }
  </style>
</head>
<body>

<!-- ヘッダー -->
<div class="header-section">
  <div class="container">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
      <div class="d-flex align-items-center gap-3">
        <i class="fas fa-chart-line fa-2x"></i>
        <h1>参加分析ダッシュボード</h1>
      </div>
      <div class="user-badge">
        <i class="fas fa-user"></i> ユーザーID: <strong>{{ user_id }}</strong>
      </div>
    </div>
  </div>
</div>

<div class="container pb-5">

  <!-- KPI セクション -->
  <div class="row g-3 mb-4" id="kpiRow">
    <div class="col-md-6 col-lg-3">
      <div class="card kpi-card primary">
        <i class="fas fa-calendar-check kpi-icon"></i>
        <div class="kpi-label">総参加回数</div>
        <div class="kpi-value" id="kpiTotal">-</div>
        <div class="kpi-subtitle">初回 / 最終</div>
        <div class="kpi-detail">
          <span id="kpiFirst">-</span> 〜 <span id="kpiLast">-</span>
        </div>
      </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
      <div class="card kpi-card success">
        <i class="fas fa-clock kpi-icon"></i>
        <div class="kpi-label">平均間隔</div>
        <div class="kpi-value"><span id="kpiAvg">-</span> <small style="font-size:1rem;">日</small></div>
        <div class="kpi-subtitle">最大間隔</div>
        <div class="kpi-detail"><span id="kpiMax">-</span> 日</div>
      </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
      <div class="card kpi-card warning">
        <i class="fas fa-fire kpi-icon"></i>
        <div class="kpi-label">連続回数</div>
        <div class="kpi-value" id="kpiStreakCur">-</div>
        <div class="kpi-subtitle">過去最大</div>
        <div class="kpi-detail"><span id="kpiStreakMax">-</span> 回</div>
      </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
      <div class="card kpi-card info">
        <i class="fas fa-calendar-alt kpi-icon"></i>
        <div class="kpi-label">分析期間</div>
        <div class="kpi-value" style="font-size:1.4rem;" id="kpiRangeEnd">-</div>
        <div class="kpi-subtitle">開始日</div>
        <div class="kpi-detail" id="kpiRangeStart">-</div>
      </div>
    </div>
  </div>

  <!-- チャート セクション -->
  <div class="row g-3 mb-4">
    <!-- 月別参加数 -->
    <div class="col-lg-6">
      <div class="card chart-card">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
          <div class="chart-title">
            <i class="fas fa-chart-bar"></i>
            <span>月別参加数</span>
          </div>
          <div class="chart-toolbar">
            <button class="btn btn-chart active" id="btnMonthlyCompact">
              <i class="fas fa-compress"></i> コンパクト
            </button>
            <button class="btn btn-chart" id="btnMonthlyFull">
              <i class="fas fa-expand"></i> フル
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartMonthly"></canvas>
        </div>
      </div>
    </div>
    
    <!-- 曜日別参加数 -->
    <div class="col-lg-6">
      <div class="card chart-card">
        <div class="chart-title">
          <i class="fas fa-calendar-week"></i>
          <span>曜日別参加数</span>
        </div>
        <div class="chart-container">
          <canvas id="chartWeekday"></canvas>
        </div>
      </div>
    </div>
    
    <!-- 時間帯別 -->
    <div class="col-lg-12">
      <div class="card chart-card">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
          <div class="chart-title">
            <i class="fas fa-clock"></i>
            <span>時間帯別参加（登録時刻）</span>
          </div>
          <div class="chart-toolbar">
            <button class="btn btn-chart active" id="btnHourCompact">
              <i class="fas fa-compress"></i> コンパクト
            </button>
            <button class="btn btn-chart" id="btnHourFull">
              <i class="fas fa-expand"></i> フル
            </button>
          </div>
        </div>
        <div class="chart-container-large">
          <canvas id="chartHour"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- 参加日一覧 -->
  <div class="card dates-card">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
      <span><i class="fas fa-list"></i> 参加日一覧</span>
      <small><i class="fas fa-copy"></i> クリックでコピー</small>
    </div>
    <div class="card-body" id="datesWrap">
      <div class="loading">
        <div class="spinner"></div>
        <div>データを読み込み中...</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const userId = "{{ user_id }}";
  const apiUrl = "{{ url_for('analytics.analytics_user_participation', user_id=user_id, group='month') }}";

  const JP_WEEKDAYS = ["月","火","水","木","金","土","日"];
  const HOUR_KEYS = Array.from({length: 24}, (_,i)=> String(i).padStart(2, '0'));

  // グラデーションカラー
  const chartColors = {
    primary: 'rgba(74, 144, 226, 0.8)',
    primaryBorder: 'rgba(74, 144, 226, 1)',
    gradient: function(ctx) {
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
      gradient.addColorStop(1, 'rgba(118, 75, 162, 0.8)');
      return gradient;
    }
  };

  // 共通チャートオプション
  const commonBarOpts = {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: { 
        grid: { display: false },
        ticks: { 
          autoSkip: true,
          maxTicksLimit: 12,
          font: { size: 11, weight: '500' },
          color: '#6c757d'
        }
      },
      y: { 
        beginAtZero: true,
        ticks: { 
          stepSize: 1,
          font: { size: 11, weight: '500' },
          color: '#6c757d'
        },
        grid: { color: 'rgba(0, 0, 0, 0.05)' }
      }
    },
    plugins: { 
      legend: { display: false },
      tooltip: { 
        mode: 'index',
        intersect: false,
        backgroundColor: 'rgba(0, 0, 0, 0.8)',
        padding: 12,
        cornerRadius: 8,
        titleFont: { size: 13, weight: 'bold' },
        bodyFont: { size: 12 }
      }
    }
  };

  function takeLast(arr, n){ return arr.slice(Math.max(arr.length - n, 0)); }

  function bucketHours(byHour, buckets) {
    const out = [];
    for (const b of buckets) {
      let sum = 0;
      for (let h=b.from; h<=b.to; h++){
        const k = String(h).padStart(2,'0');
        sum += (byHour[k] || 0);
      }
      out.push({label: b.label, count: sum});
    }
    return out;
  }

  function setKPI(json){
    const t = json.totals || {};
    const r = json.range || {};
    const s = json.streaks || {};

    document.getElementById('kpiTotal').textContent = t.participations ?? '-';
    document.getElementById('kpiFirst').textContent = t.first_date ?? '-';
    document.getElementById('kpiLast').textContent  = t.last_date ?? '-';

    document.getElementById('kpiAvg').textContent = (t.avg_interval_days != null) ? t.avg_interval_days : '-';
    document.getElementById('kpiMax').textContent = (t.max_gap_days != null) ? t.max_gap_days : '-';

    document.getElementById('kpiStreakCur').textContent = s.current_streak ?? '-';
    document.getElementById('kpiStreakMax').textContent = s.max_streak ?? '-';

    document.getElementById('kpiRangeStart').textContent = r.start ?? '-';
    document.getElementById('kpiRangeEnd').textContent   = r.end ?? '-';
  }

  // ボタンの切り替え処理
  function toggleButtons(activeBtn, inactiveBtn) {
    activeBtn.classList.add('active');
    inactiveBtn.classList.remove('active');
  }

  // ===== 月別チャート =====
  let chartMonthly = null;
  function buildMonthlyChart(json, mode='compact'){
    const ctx = document.getElementById('chartMonthly').getContext('2d');
    const byGroup = (json.distributions?.by_group || []).slice().sort((a,b)=> a.group.localeCompare(b.group));
    const src = (mode === 'compact') ? takeLast(byGroup, 6) : byGroup;
    const labels = src.map(x => x.group);
    const data   = src.map(x => x.count);

    if (chartMonthly) chartMonthly.destroy();
    
    const gradient = chartColors.gradient(ctx);
    
    chartMonthly = new Chart(ctx, {
      type: 'bar',
      data: { 
        labels,
        datasets: [{
          data,
          backgroundColor: gradient,
          borderColor: chartColors.primaryBorder,
          borderWidth: 2,
          borderRadius: 8,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: commonBarOpts
    });
  }

  // ===== 曜日別チャート =====
  let chartWeekday = null;
  function buildWeekdayChart(json){
    const ctx = document.getElementById('chartWeekday').getContext('2d');
    const byW  = json.distributions?.by_weekday || {};
    const labels = JP_WEEKDAYS;
    const data   = labels.map(k => byW[k] ?? 0);

    if (chartWeekday) chartWeekday.destroy();
    
    // 曜日ごとに異なる色
    const colors = [
      'rgba(74, 144, 226, 0.8)',   // 月
      'rgba(80, 200, 120, 0.8)',   // 火
      'rgba(255, 165, 0, 0.8)',    // 水
      'rgba(123, 104, 238, 0.8)',  // 木
      'rgba(255, 99, 132, 0.8)',   // 金
      'rgba(54, 162, 235, 0.8)',   // 土
      'rgba(255, 206, 86, 0.8)'    // 日
    ];

    chartWeekday = new Chart(ctx, {
      type: 'bar',
      data: { 
        labels,
        datasets: [{
          data,
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace('0.8', '1')),
          borderWidth: 2,
          borderRadius: 8,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        ...commonBarOpts,
        indexAxis: 'y',
        scales: {
          x: { 
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              font: { size: 11, weight: '500' },
              color: '#6c757d'
            },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          },
          y: { 
            grid: { display: false },
            ticks: {
              font: { size: 12, weight: '600' },
              color: '#2c3e50'
            }
          }
        }
      }
    });
  }

  // ===== 時間帯チャート =====
  let chartHour = null;
  function buildHourChart(json, mode='compact'){
    const ctx = document.getElementById('chartHour').getContext('2d');
    const byH = json.distributions?.by_hour || {};

    let labels, data;
    if (mode === 'compact') {
      const buckets = [
        {label:'深夜 (0-5)',  from:0,  to:5},
        {label:'朝 (6-11)',   from:6,  to:11},
        {label:'昼 (12-17)',  from:12, to:17},
        {label:'夜 (18-23)',  from:18, to:23},
      ];
      const agg = bucketHours(byH, buckets);
      labels = agg.map(x=>x.label);
      data   = agg.map(x=>x.count);
    } else {
      labels = HOUR_KEYS.map(h => h + '時');
      data   = HOUR_KEYS.map(k => byH[k] ?? 0);
    }

    if (chartHour) chartHour.destroy();
    
    const gradient = chartColors.gradient(ctx);
    
    chartHour = new Chart(ctx, {
      type: 'bar',
      data: { 
        labels,
        datasets: [{
          data,
          backgroundColor: gradient,
          borderColor: chartColors.primaryBorder,
          borderWidth: 2,
          borderRadius: 8,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        ...commonBarOpts,
        scales: {
          x: { 
            grid: { display: false },
            ticks: { 
              autoSkip: mode === 'full',
              maxRotation: 0,
              font: { size: 11, weight: '500' },
              color: '#6c757d'
            }
          },
          y: { 
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              font: { size: 11, weight: '500' },
              color: '#6c757d'
            },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          }
        }
      }
    });
  }

  // 参加日一覧
  function buildDates(json){
    const wrap = document.getElementById('datesWrap');
    const dates = json.dates || [];
    
    if(!dates.length){
      wrap.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-inbox fa-3x mb-3 d-block"></i>データがありません。</div>';
      return;
    }
    
    const groups = {};
    for(const d of dates){
      const ym = d.slice(0,7);
      groups[ym] = groups[ym] || [];
      groups[ym].push(d);
    }
    
    const frag = document.createDocumentFragment();
    Object.keys(groups).sort().reverse().forEach(ym=>{ // 新しい月から表示
      const h = document.createElement('div');
      h.textContent = ym;
      h.className = 'dates-month-title';
      frag.appendChild(h);

      const div = document.createElement('div');
      groups[ym].forEach(d=>{
        const a = document.createElement('a');
        a.textContent = d;
        a.href = 'javascript:void(0)';
        a.className = 'dates-badge';
        a.title = 'クリックでコピー';
        a.addEventListener('click', ()=> {
          navigator.clipboard.writeText(d);
          // コピー成功のフィードバック
          const originalText = a.textContent;
          a.textContent = '✓ コピーしました';
          setTimeout(() => a.textContent = originalText, 1000);
        });
        div.appendChild(a);
      });
      frag.appendChild(div);
    });
    
    wrap.innerHTML = '';
    wrap.appendChild(frag);
  }

  // 初期化
  async function main(){
    try{
      const res = await fetch(apiUrl, { credentials: 'same-origin' });
      if(!res.ok) throw new Error('API error: ' + res.status);
      const json = await res.json();

      setKPI(json);
      buildMonthlyChart(json, 'compact');
      buildWeekdayChart(json);
      buildHourChart(json, 'compact');
      buildDates(json);

      // 月別切替ボタン
      const btnMonthlyCompact = document.getElementById('btnMonthlyCompact');
      const btnMonthlyFull = document.getElementById('btnMonthlyFull');
      btnMonthlyCompact.onclick = ()=> {
        buildMonthlyChart(json, 'compact');
        toggleButtons(btnMonthlyCompact, btnMonthlyFull);
      };
      btnMonthlyFull.onclick = ()=> {
        buildMonthlyChart(json, 'full');
        toggleButtons(btnMonthlyFull, btnMonthlyCompact);
      };

      // 時間帯切替ボタン
      const btnHourCompact = document.getElementById('btnHourCompact');
      const btnHourFull = document.getElementById('btnHourFull');
      btnHourCompact.onclick = ()=> {
        buildHourChart(json, 'compact');
        toggleButtons(btnHourCompact, btnHourFull);
      };
      btnHourFull.onclick = ()=> {
        buildHourChart(json, 'full');
        toggleButtons(btnHourFull, btnHourCompact);
      };

    }catch(err){
      console.error(err);
      const c = document.querySelector('.container');
      const div = document.createElement('div');
      div.className = 'alert alert-danger alert-custom mt-3';
      div.innerHTML = '<i class="fas fa-exclamation-triangle"></i> データ取得に失敗しました。ページを再読み込みしてください。';
      c.prepend(div);
    }
  }
  
  main();
})();
</script>
</body>
</html>