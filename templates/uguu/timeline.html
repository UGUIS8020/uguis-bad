{% extends "base.html" %}

{# SEO最適化 - メタタグ #}
{% block title %}うぐすたぐらむ | 鶯バドミントンクラブ公式コミュニティ{% endblock %}
{% block description %}鶯バドミントンクラブの公式コミュニティ「うぐすたぐらむ」。練習情報、試合結果、メンバー交流など最新情報をリアルタイムでお届け。バドミントン愛好家のための交流プラットフォームです。{% endblock %}
{% block keywords %}鶯バドミントンクラブ,バドミントン,うぐすたぐらむ,練習スケジュール,試合結果,バドミントンコミュニティ,スポーツ交流,掲示板,SNS{% endblock %}

{# Open Graph / SNSシェア対策 #}
{% block og_tags %}
<meta property="og:title" content="うぐすたぐらむ | 鶯バドミントンクラブ公式コミュニティ">
<meta property="og:description" content="鶯バドミントンクラブのメンバー交流、練習情報、試合結果を共有するコミュニティプラットフォーム">
<meta property="og:type" content="website">
<meta property="og:url" content="{{ request.url }}">
<meta property="og:image" content="{{ url_for('static', filename='images/ogp.jpg', _external=True) }}">
<meta property="og:site_name" content="うぐすたぐらむ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="うぐすたぐらむ | 鶯バドミントンクラブ">
<meta name="twitter:description" content="バドミントン愛好家のための交流プラットフォーム">
{% endblock %}

{# 構造化データ（JSON-LD） #}
{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SportsOrganization",
  "name": "鶯バドミントンクラブ",
  "url": "{{ request.url_root }}",
  "logo": "{{ url_for('static', filename='images/logo.png', _external=True) }}",
  "description": "鶯バドミントンクラブの公式コミュニティサイト",
  "sport": "バドミントン",
  "sameAs": []
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "投稿一覧",
  "itemListElement": [
    {% for post in posts %}
    {
      "@type": "SocialMediaPosting",
      "headline": "{{ post.display_name }}の投稿",
      "author": {
        "@type": "Person",
        "name": "{{ post.display_name }}"
      },
      "datePublished": "{{ post.created_at }}",
      "articleBody": "{{ post.content[:100] }}",
      "interactionStatistic": [
        {
          "@type": "InteractionCounter",
          "interactionType": "https://schema.org/LikeAction",
          "userInteractionCount": {{ post.likes_count|default(0) }}
        },
        {
          "@type": "InteractionCounter",
          "interactionType": "https://schema.org/CommentAction",
          "userInteractionCount": {{ post.replies_count|default(0) }}
        }
      ]
      {% if post.image_url %}
      ,"image": "{{ post.image_url }}"
      {% endif %}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
{% endblock %}
{% block content %}

<style>
    .avatar-ig{
        --size: 40px;
        --ring: 2px;
        --gap: 1px;
        display:inline-grid; 
        place-items:center;
        width:calc(var(--size) + (var(--ring)+var(--gap))*2);
        height:calc(var(--size) + (var(--ring)+var(--gap))*2);
        border-radius:50%;
        padding:calc(var(--ring) + var(--gap));
        background:conic-gradient(#feda75,#fa7e1e,#d62976,#962fbf,#4f5bd5,#feda75);
    }
    .avatar-ig>img{
        width:var(--size); 
        height:var(--size);
        border-radius:50%; 
        object-fit:cover; 
        display:block;
        background:#fff; 
        box-shadow:0 0 0 var(--gap) #fff;
    }
    
    .timeline-container {
        max-width: 600px;
        margin: 0 auto;
    }
    
    /* PC表示時の投稿間隔 */
    @media (min-width: 769px) {
        .timeline-container .card {
            margin-bottom: 2rem;
        }
    }
    
    @media (max-width: 768px) {
        .timeline-container {
            max-width: 100%;
            padding: 0;
        }
        
        .mobile-full-width-media {
            width: 100vw;
            position: relative;
            left: 50%;
            right: 50%;
            margin-left: -50vw;
            margin-right: -50vw;
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        
        /* 画像用のスタイル */
        .mobile-full-width-media img {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 95vh;
            object-fit: contain;
        }
        
        /* YouTube動画用のスタイル */
        .mobile-full-width-media iframe {
            width: 100vw !important;
            height: 95vh !important;
            max-width: 100vw !important;
            border: none;
        }
        
        .timeline-container .card {
            border-radius: 0;
            border-left: none;
            border-right: none;
            margin-bottom: 0 !important;
        }
        
        .timeline-container .card-header,
        .timeline-container .card-body {
            padding-left: 15px;
            padding-right: 15px;
        }
        
        /* 投稿間の区切り線 */
        .timeline-container .card + .card {
            border-top: 8px solid #f0f0f0;
        }
    }
    
    /* PC向けの共通スタイル（既存） */
    @media (min-width: 769px) {
    .mobile-full-width-media {
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .mobile-full-width-media img {
        width: 100%;
        max-height: 600px;
        object-fit: contain;
    }
    .mobile-full-width-media iframe {
        width: 100%;
        height: 450px;
    }
    }  /* ← 必ずここで閉じる */

    /* ===== ここから縦表示系（スマホ/PC共通で効かせる） ===== */

    /* Instagram風：縦写真/縦動画（4:5） */
    .ig-portrait-frame{
    width:100vw;
    aspect-ratio:4/5;
    position:relative;
    left:50%; right:50%;
    margin-left:-50vw; margin-right:-50vw;
    background:#000;
    overflow:hidden;
    }
    .ig-portrait-frame > img,
    .ig-portrait-frame > video{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;   /* 画面いっぱいに表示（多少トリミング） */
    }

    /* YouTubeショート（9:16） */
    .shorts-frame{
    width:100vw;
    aspect-ratio:9/16;
    position:relative;
    left:50%; right:50%;
    margin-left:-50vw; margin-right:-50vw;
    background:#000;
    overflow:hidden;
    }
    .shorts-frame > iframe,
    .shorts-frame > video{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    }

    /* プレイヤー自体を拡大して左右の帯をカット（中央トリミング） */
    .shorts-frame.crop{ position:relative; overflow:hidden; }
    .shorts-frame.crop iframe{
    position:absolute; top:0; left:50%;
    height:100%;
    width:177.78%;              /* = 100 * (16 / 9) */
    transform:translateX(-50%);
    border:0;
    }
    /* 念のための強制 */
    .shorts-frame iframe{ width:100% !important; height:100% !important; }

    /* PCだけ中央600pxに収める */
    @media (min-width:769px){
    .ig-portrait-frame,
    .shorts-frame{
        width:600px;
        left:50%; right:auto;
        margin-left:-300px; margin-right:0;
        border-radius:8px;
    }
    }
    
</style>

<div class="container-fluid">
    <div class="row">
        <!-- 左サイドバー -->
        <aside class="col-1 border-end d-none d-md-block" role="complementary" aria-label="サイドバー">
        </aside>

        <!-- メインコンテンツエリア -->
        <main class="col-12 col-md-10" role="main">
            <div class="timeline-container">
                <!-- ページ見出し（SEO用・非表示） -->
                <h1 class="visually-hidden">うぐすたぐらむ - 鶯バドミントンクラブ投稿タイムライン</h1>
                
                <!-- 新規投稿ボタン -->
                <nav class="d-flex my-3 px-3 px-md-0" aria-label="投稿アクション">
                    <a href="{{ url_for('post.create_post') }}" 
                       class="nav-link text-dark"
                       aria-label="新しい投稿を作成">
                        <i class="fas fa-pencil-alt" aria-hidden="true"></i> 新規投稿
                    </a>
                </nav>
                
                <!-- 投稿一覧 -->
                <section class="posts" aria-label="投稿一覧">
                    {% for post in posts %}
                    <article class="card mb-4 mt-2 shadow-sm" 
                             itemscope 
                             itemtype="https://schema.org/SocialMediaPosting"
                             aria-label="{{ post.display_name }}さんの投稿">
                        <!-- カードヘッダー -->
                        <header class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    <!-- プロフィール画像 -->
                                    <a href="{{ url_for('users.user_profile', user_id=post.user_id) }}"
                                       aria-label="{{ post.display_name }}さんのプロフィールを見る">
                                        <span class="avatar-ig" 
                                              style="--size:40px;--ring:2px;--gap:1px;" 
                                              title="{{ post.display_name }}">
                                            <img
                                                src="{{ post.profile_image_url or url_for('static', filename='images/default.jpg') }}"
                                                alt="{{ post.display_name }}さんのプロフィール画像"
                                                width="40" 
                                                height="40" 
                                                loading="lazy" 
                                                decoding="async"
                                                itemprop="image"
                                                onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/default.jpg') }}'">
                                        </span>
                                    </a>
                                    
                                    <!-- 投稿者名 -->
                                    <div>
                                        <h2 class="mb-0 h5">
                                            <a href="{{ url_for('users.user_profile', user_id=post.user_id) }}" 
                                               class="text-dark text-decoration-none hover-underline"
                                               itemprop="author"
                                               itemscope
                                               itemtype="https://schema.org/Person">
                                                <strong itemprop="name">{{ post.display_name }}</strong>
                                            </a>                                    
                                        </h2>
                                    </div>
                                </div>
                                
                                <div class="d-flex align-items-center gap-2">
                                    <time class="text-muted" 
                                          datetime="{{ post.created_at }}"
                                          itemprop="datePublished">
                                        {{ post.created_at.split('T')[0] }}
                                    </time>
                                    
                                    <!-- 投稿者本人のみ編集・削除ボタン -->
                                    {% if current_user.is_authenticated and current_user.id == post.user_id %}
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                type="button" 
                                                data-bs-toggle="dropdown" 
                                                aria-expanded="false"
                                                aria-label="投稿オプション">
                                            <i class="fas fa-ellipsis-h" aria-hidden="true"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('post.edit_post', post_id=post.post_id) }}"
                                                   aria-label="投稿を編集">
                                                    <i class="fas fa-edit" aria-hidden="true"></i> 編集
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <form method="POST" 
                                                      action="{{ url_for('post.delete_post', post_id=post.post_id) }}" 
                                                      class="d-inline" 
                                                      onsubmit="return confirm('この投稿を削除しますか？')">
                                                    <button type="submit" 
                                                            class="dropdown-item text-danger"
                                                            aria-label="投稿を削除">
                                                        <i class="fas fa-trash" aria-hidden="true"></i> 削除
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </header>
                        
                        <!-- 画像 -->
                        {% if post.image_url %}
                        <figure class="ig-portrait-frame">
                            <img src="{{ post.image_url }}"
                                alt="{{ post.display_name }}さんが投稿した画像{% if post.content %}: {{ post.content[:50] }}{% endif %}"
                                itemprop="image"
                                loading="lazy"
                                decoding="async">
                        </figure>
                        {% endif %}
                        
                        <!-- YouTube動画 -->
                        {% if post.youtube_url %}
                        {% set y = post.youtube_url %}
                        {% if 'shorts' in y %}
                            {# Shorts専用：縦長9:16で表示 #}
                            {% set vid = y.split('/shorts/')[-1].split('?')[0] %}
                            <div class="shorts-frame crop">
                            <iframe
                                src="https://www.youtube.com/embed/{{ vid }}?playsinline=1&rel=0&modestbranding=1"
                                title="{{ post.display_name }}さんが共有したYouTubeショート"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowfullscreen
                                loading="lazy">
                            </iframe>
                            </div>
                        {% else %}
                            {# 通常動画（16:9） #}
                            <div class="bg-light mobile-full-width-media">
                            <iframe
                                src="{% if y.startswith('https://www.youtube.com/embed/') %}
                                    {{ y }}
                                    {% elif 'youtube.com' in y %}
                                    {{ 'https://www.youtube.com/embed/' + y.split('v=')[-1].split('&')[0] }}
                                    {% else %}
                                    {{ 'https://www.youtube.com/embed/' + y.split('/')[-1] }}
                                    {% endif %}"
                                title="{{ post.display_name }}さんが共有したYouTube動画"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen
                                loading="lazy">
                            </iframe>
                            </div>
                        {% endif %}
                        {% endif %}
                        
                        <!-- カードボディ -->
                        <div class="card-body">
                            <p class="card-text" 
                               style="white-space: pre-line;"
                               itemprop="articleBody">{{ post.content }}</p>

                            <!-- アクションボタン -->
                            <div class="d-flex justify-content-between align-items-center mt-3" 
                                 role="group"
                                 aria-label="投稿アクション">
                                <div class="btn-group">
                                    <!-- いいねボタン -->
                                    {% if post.post_id %}
                                    <form action="{{ url_for('post.like_post', post_id=post.post_id) }}" 
                                          method="POST" 
                                          class="d-inline">
                                        <div class="btn-group">
                                            <button type="button" 
                                                    onclick="handleLike('{{ post.post_id }}')" 
                                                    class="btn btn-link p-0 border-0 text-decoration-none me-3" 
                                                    style="box-shadow: none;"
                                                    aria-label="いいね {{ post.likes_count|default(0) }}件">
                                                <i class="far fa-heart" 
                                                   id="heart-{{ post.post_id }}"
                                                   aria-hidden="true"></i>
                                                <span class="ms-1" 
                                                      id="likes-count-{{ post.post_id }}"
                                                      itemprop="interactionStatistic"
                                                      itemscope
                                                      itemtype="https://schema.org/InteractionCounter">
                                                    <meta itemprop="interactionType" content="https://schema.org/LikeAction">
                                                    <span itemprop="userInteractionCount">{{ post.likes_count|default(0) }}</span>
                                                </span>
                                            </button>
                                        </div>
                                    </form>
                                    {% else %}
                                    <div class="d-inline">
                                        <div class="btn-group">
                                            <button type="button" 
                                                    class="btn btn-link p-0 border-0 text-decoration-none me-3" 
                                                    style="box-shadow: none;" 
                                                    disabled
                                                    aria-label="いいね {{ post.likes_count|default(0) }}件">
                                                <i class="far fa-heart" aria-hidden="true"></i>
                                                <span class="ms-1">{{ post.likes_count|default(0) }}</span>
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}          

                                    <!-- 返信ボタン -->
                                    {% if post.post_id %}
                                    <button type="button" 
                                            class="btn btn-link p-0 border-0 text-decoration-none" 
                                            style="box-shadow: none;"
                                            onclick="toggleReplyForm('{{ post.post_id }}')"
                                            aria-label="コメント {{ post.replies_count|default(0) }}件"
                                            aria-expanded="false"
                                            aria-controls="reply-form-{{ post.post_id }}">
                                        <i class="far fa-comment" aria-hidden="true"></i>
                                        <span class="ms-1" 
                                              id="replies-count-{{ post.post_id }}"
                                              itemprop="interactionStatistic"
                                              itemscope
                                              itemtype="https://schema.org/InteractionCounter">
                                            <meta itemprop="interactionType" content="https://schema.org/CommentAction">
                                            <span itemprop="userInteractionCount">{{ post.replies_count|default(0) }}</span>
                                        </span>
                                    </button>
                                    {% else %}
                                    <button type="button" 
                                            class="btn btn-link p-0 border-0 text-decoration-none" 
                                            style="box-shadow: none;" 
                                            disabled
                                            aria-label="コメント {{ post.replies_count|default(0) }}件">
                                        <i class="far fa-comment" aria-hidden="true"></i>
                                        <span class="ms-1">{{ post.replies_count|default(0) }}</span>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- 返信フォーム -->
                            {% if post.post_id %}
                            <div id="reply-form-{{ post.post_id }}" 
                                 class="mt-3" 
                                 style="display: none;"
                                 role="form"
                                 aria-label="返信フォーム">
                                <form action="{{ url_for('post.create_reply', post_id=post.post_id) }}" 
                                      method="POST">
                                    <div class="form-group">
                                        <label for="reply-content-{{ post.post_id }}" class="visually-hidden">
                                            返信内容
                                        </label>
                                        <textarea class="form-control" 
                                                  id="reply-content-{{ post.post_id }}"
                                                  name="content" 
                                                  rows="2" 
                                                  placeholder="返信を入力..."
                                                  required
                                                  aria-required="true"></textarea>
                                    </div>
                                    <button type="submit" 
                                            class="btn btn-primary btn-sm mt-2"
                                            aria-label="返信を投稿">返信する</button>
                                </form>
                            </div>
                            {% endif %}

                            <!-- 返信一覧 -->
                            {% if post.post_id and post.replies %}
                            <section id="replies-{{ post.post_id }}" 
                                     class="mt-3"
                                     aria-label="返信一覧"
                                     itemprop="comment"
                                     itemscope
                                     itemtype="https://schema.org/Comment">
                                {% for reply in post.replies %}
                                <article class="card mb-2">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <a href="{{ url_for('users.user_profile', user_id=reply.user_id) }}" 
                                                   class="text-dark text-decoration-none"
                                                   itemprop="author"
                                                   itemscope
                                                   itemtype="https://schema.org/Person">
                                                    <strong itemprop="name">{{ reply.display_name }}</strong>
                                                </a>
                                            </div>
                                            <time class="text-muted" 
                                                  datetime="{{ reply.created_at }}"
                                                  itemprop="datePublished">
                                                {{ reply.created_at.split('T')[0] }}
                                            </time>
                                        </div>
                                        <p class="mb-0 mt-1" itemprop="text">{{ reply.content }}</p>
                                    </div>
                                </article>
                                {% endfor %}
                            </section>
                            {% endif %}
                        </div>
                    </article>
                    {% endfor %}
                    
                    {% if not posts %}
                    <div class="alert alert-info" role="alert">
                        <p class="mb-0">まだ投稿がありません。最初の投稿を作成してみましょう！</p>
                    </div>
                    {% endif %}
                </section>
            </div>
        </main>

        <!-- 右側の余白 -->
        <aside class="col-1 d-none d-md-block" role="complementary"></aside>
    </div>
</div>

<script>
function toggleReplyForm(postId) {
    const replyForm = document.getElementById(`reply-form-${postId}`);
    const isHidden = replyForm.style.display === 'none';
    replyForm.style.display = isHidden ? 'block' : 'none';
    
    // アクセシビリティのためaria-expanded属性を更新
    const button = document.querySelector(`[aria-controls="reply-form-${postId}"]`);
    if (button) {
        button.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
    }
}

async function handleLike(postId) {
    try {
        const response = await fetch(`/uguu/like/${postId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        if (response.ok) {
            const heartIcon = document.getElementById(`heart-${postId}`);
            const likesCount = document.getElementById(`likes-count-${postId}`);
            const button = heartIcon.closest('button');
            
            heartIcon.classList.toggle('fas', data.is_liked);
            heartIcon.classList.toggle('far', !data.is_liked);
            
            // いいね数とカウント内のテキストを更新
            const countSpan = likesCount.querySelector('[itemprop="userInteractionCount"]') || likesCount;
            countSpan.textContent = data.likes_count;
            
            // ボタンのaria-labelを更新
            if (button) {
                button.setAttribute('aria-label', `いいね ${data.likes_count}件`);
            }
        } else {
            console.error('Error:', data.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>

{% endblock %}